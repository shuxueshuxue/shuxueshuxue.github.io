<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Symmetry - Group Theory Game</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0c0c0c 0%, #1a1a2e 50%, #16213e 100%);
            color: #e0e6ed;
            overflow: hidden;
            user-select: none;
            min-height: 100vh;
        }

        .container {
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        /* 背景装饰 */
        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(78, 205, 196, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(255, 107, 107, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(130, 119, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
        }

        .screen {
            display: none;
            width: 100%;
            height: 100%;
            position: relative;
            animation: fadeIn 0.5s ease-in-out;
        }

        .screen.active {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        @keyframes glow {
            0%, 100% { box-shadow: 0 0 5px rgba(78, 205, 196, 0.3); }
            50% { box-shadow: 0 0 20px rgba(78, 205, 196, 0.6), 0 0 30px rgba(78, 205, 196, 0.3); }
        }

        /* 主菜单 */
        .main-menu {
            text-align: center;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 25px;
            z-index: 10;
        }

        .game-title {
            width: 450px;
            height: 120px;
            margin-bottom: 40px;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 450 120"><text x="50%" y="50%" font-family="Arial Black" font-size="48" fill="url(%23grad)" text-anchor="middle" dominant-baseline="middle">SYMMETRY</text><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23ff6b6b"/><stop offset="30%" style="stop-color:%234ecdc4"/><stop offset="70%" style="stop-color:%238277ff"/><stop offset="100%" style="stop-color:%23ff6b6b"/></linearGradient></defs></svg>') no-repeat center;
            background-size: contain;
            animation: glow 3s infinite;
        }

        .menu-button {
            display: block;
            width: 250px;
            padding: 20px 35px;
            background: rgba(30, 30, 50, 0.8);
            color: #e0e6ed;
            border: 2px solid #4ecdc4;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .menu-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.3), transparent);
            transition: left 0.5s;
        }

        .menu-button:hover::before {
            left: 100%;
        }

        .menu-button:hover {
            color: #4ecdc4;
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.3);
        }

        .triangle-decoration {
            position: absolute;
            left: -150px;
            top: 50%;
            transform: translateY(-50%);
            width: 200px;
            height: 200px;
            background: conic-gradient(from 0deg, rgba(78, 205, 196, 0.3), rgba(255, 107, 107, 0.3), rgba(130, 119, 255, 0.3), rgba(78, 205, 196, 0.3));
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            animation: pulse 4s infinite;
        }

        /* 游戏菜单 */
        .game-menu {
            width: 950px;
            max-height: 85vh;
            overflow-y: auto;
            padding: 30px;
            background: rgba(20, 20, 35, 0.9);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .level-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 20px 0;
            padding: 25px 35px;
            background: rgba(30, 30, 50, 0.8);
            border: 2px solid rgba(160, 82, 45, 0.6);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.4s ease;
            backdrop-filter: blur(10px);
        }

        .level-row:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(78, 205, 196, 0.2);
        }

        .level-label {
            font-size: 24px;
            font-weight: 700;
            width: 200px;
            text-align: left;
            color: #fff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .level-buttons {
            display: flex;
            gap: 25px;
            align-items: center;
        }

        .level-button {
            padding: 15px 30px;
            background: rgba(50, 50, 70, 0.8);
            color: #e0e6ed;
            border: 2px solid #646464;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 500;
            min-width: 160px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .level-button:hover:not(.disabled) {
            color: #4ecdc4;
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            transform: scale(1.05);
        }

        .level-button.disabled {
            color: #666;
            border-color: #444;
            cursor: not-allowed;
            background: rgba(30, 30, 30, 0.6);
        }

        /* 游戏界面 */
        .game-area {
            display: flex;
            gap: 60px;
            align-items: flex-start;
            padding: 30px;
            justify-content: center;
        }

        .table-section {
            text-align: center;
        }

        .multiplication-table {
            display: inline-grid;
            gap: 3px;
            background: rgba(30, 30, 50, 0.9);
            padding: 8px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .cell {
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            border-radius: 8px;
            position: relative;
            overflow: hidden;
        }

        .cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .cell:hover::before {
            opacity: 1;
        }

        .cell.header {
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            background: rgba(50, 50, 70, 0.9);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .cell.header.selected {
            border: 3px solid #ff6b6b;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.6);
        }

        .cell:not(.header):hover {
            border: 2px solid #646464;
            transform: scale(1.1);
            box-shadow: 0 0 10px rgba(100, 100, 100, 0.3);
        }

        .cell.selected {
            border: 2px solid #4ecdc4;
            transform: scale(1.1);
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.6);
        }

        .cell.immutable {
            background: rgba(26, 26, 26, 0.9) !important;
            color: #ff6b6b !important;
            cursor: not-allowed;
            font-weight: bold;
            box-shadow: inset 0 0 10px rgba(255, 107, 107, 0.3);
        }

        .control-panel {
            background: rgba(30, 30, 50, 0.9);
            padding: 30px;
            border: 2px solid rgba(160, 82, 45, 0.6);
            border-radius: 20px;
            width: 280px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }

        .info-section {
            margin-bottom: 30px;
            font-size: 15px;
            line-height: 1.8;
            padding: 20px;
            background: rgba(20, 20, 35, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .info-section strong {
            color: #4ecdc4;
            display: block;
            margin-bottom: 15px;
            font-size: 18px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .control-button {
            width: 100%;
            padding: 16px;
            margin: 15px 0;
            background: rgba(50, 50, 70, 0.8);
            color: #e0e6ed;
            border: 2px solid #646464;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            backdrop-filter: blur(5px);
        }

        .control-button:hover {
            border-color: #4ecdc4;
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        .control-button.primary {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.3);
            color: #fff;
        }

        .control-button.primary:hover {
            background: rgba(78, 205, 196, 0.4);
        }

        /* 画廊 */
        .gallery {
            width: 90%;
            max-width: 1200px;
            height: 85vh;
            overflow-y: auto;
            padding: 30px;
            background: rgba(20, 20, 35, 0.9);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(78, 205, 196, 0.3);
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .group-card {
            border: 2px solid rgba(78, 205, 196, 0.3);
            padding: 20px;
            background: rgba(30, 30, 50, 0.6);
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            text-align: center;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .group-card:hover {
            border-color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.2);
        }

        .group-card.unknown {
            color: #666;
            font-size: 48px;
            background: rgba(40, 40, 60, 0.3);
            border-color: rgba(100, 100, 100, 0.3);
        }

        .group-card.unknown:hover {
            border-color: #999;
            background: rgba(60, 60, 80, 0.4);
        }

        .group-info {
            text-align: center;
        }

        .group-info h3 {
            color: #4ecdc4;
            font-size: 24px;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .group-info .order {
            color: #ff6b6b;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .group-info .description {
            color: #b4b4b4;
            font-size: 14px;
            line-height: 1.4;
        }

        .group-table-preview {
            width: 120px;
            height: 120px;
            display: grid;
            gap: 1px;
            background: rgba(20, 20, 35, 0.8);
            padding: 3px;
            border-radius: 6px;
            margin: 15px auto 0;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .preview-cell {
            background: rgba(60, 60, 80, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            border-radius: 2px;
            font-weight: 600;
        }

        /* 教程 */
        .tutorial {
            width: 95%;
            max-width: 900px;
            height: 85vh;
            overflow-y: auto;
            padding: 40px;
            background: rgba(20, 20, 35, 0.9);
            border: 2px solid rgba(160, 82, 45, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(15px);
        }

        .tutorial h1 {
            color: #4ecdc4;
            text-align: center;
            margin-bottom: 30px;
            font-size: 36px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .tutorial h2 {
            color: #4ecdc4;
            margin: 30px 0 20px;
            font-size: 24px;
            border-bottom: 2px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 10px;
        }

        .tutorial p {
            margin: 15px 0;
            line-height: 1.8;
            font-size: 16px;
        }

        .tutorial strong {
            color: #ff6b6b;
        }

        /* 设置 */
        .settings {
            width: 500px;
            padding: 40px;
            background: rgba(20, 20, 35, 0.9);
            border: 2px solid rgba(160, 82, 45, 0.6);
            border-radius: 20px;
            backdrop-filter: blur(15px);
        }

        .setting-item {
            margin: 30px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 18px;
        }

        .toggle {
            width: 70px;
            height: 35px;
            background: rgba(50, 50, 70, 0.8);
            border-radius: 20px;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid #646464;
        }

        .toggle.on {
            background: rgba(78, 205, 196, 0.8);
            border-color: #4ecdc4;
        }

        .toggle-slider {
            width: 30px;
            height: 30px;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .toggle.on .toggle-slider {
            transform: translateX(35px);
        }

        select {
            padding: 12px;
            background: rgba(50, 50, 70, 0.8);
            color: #fff;
            border: 2px solid #646464;
            border-radius: 8px;
            font-size: 16px;
            backdrop-filter: blur(5px);
        }

        /* 消息框 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            animation: fadeIn 0.3s ease-in-out;
        }

        .modal-content {
            background: rgba(30, 30, 50, 0.95);
            padding: 50px;
            border: 3px solid #4ecdc4;
            border-radius: 20px;
            max-width: 600px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(15px);
            animation: pulse 0.3s ease-in-out;
        }

        .modal-content h3 {
            color: #4ecdc4;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .modal-content p {
            font-size: 18px;
            line-height: 1.6;
            margin-bottom: 30px;
        }

        .modal-button {
            padding: 15px 40px;
            margin-top: 20px;
            background: rgba(78, 205, 196, 0.3);
            color: #fff;
            border: 2px solid #4ecdc4;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
        }

        .modal-button:hover {
            background: rgba(78, 205, 196, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        /* 提示图标 */
        .hint-icon {
            position: absolute;
            top: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, #4ecdc4, #3ba99c);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 28px;
            color: #000;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.4);
        }

        .hint-icon:hover {
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(78, 205, 196, 0.6);
        }

        .hint-tooltip {
            position: absolute;
            top: 80px;
            right: 0;
            background: rgba(30, 0, 70, 0.95);
            color: #dc7800;
            padding: 20px;
            border-radius: 12px;
            max-width: 350px;
            display: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(220, 120, 0, 0.3);
            font-size: 14px;
            line-height: 1.5;
        }

        .hint-icon:hover .hint-tooltip {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        /* 返回按钮 */
        .back-button {
            position: absolute;
            top: 30px;
            left: 30px;
            padding: 15px 25px;
            background: rgba(50, 50, 70, 0.8);
            color: #e0e6ed;
            border: 2px solid #646464;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            font-weight: 600;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            border-color: #4ecdc4;
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.15);
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(78, 205, 196, 0.3);
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 14px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(26, 26, 26, 0.8);
            border-radius: 8px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #646464, #4ecdc4);
            border-radius: 8px;
            border: 2px solid rgba(26, 26, 26, 0.8);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #4ecdc4, #3ba99c);
        }

        /* 标题样式 */
        h2 {
            color: #4ecdc4;
            text-align: center;
            margin-bottom: 30px;
            font-size: 32px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        #gameTitle {
            color: #fff;
            font-size: 28px;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        /* 无群提示 */
        .no-groups-hint {
            background: rgba(255, 107, 107, 0.15);
            border: 2px solid rgba(255, 107, 107, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin: 25px 0;
            text-align: center;
            color: #ff6b6b;
            font-weight: 500;
            backdrop-filter: blur(5px);
        }

        /* 成功动画 */
        @keyframes celebration {
            0% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.1) rotate(90deg); }
            50% { transform: scale(1.2) rotate(180deg); }
            75% { transform: scale(1.1) rotate(270deg); }
            100% { transform: scale(1) rotate(360deg); }
        }

        .celebrate {
            animation: celebration 0.6s ease-in-out;
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .game-area {
                flex-direction: column;
                gap: 30px;
            }
            
            .control-panel {
                width: 100%;
                max-width: 400px;
            }
        }

        @media (max-width: 768px) {
            .gallery-grid {
                grid-template-columns: 1fr;
            }
            
            .level-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .level-buttons {
                flex-direction: column;
                width: 100%;
            }
            
            .level-button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="mainMenu" class="screen active">
            <div class="main-menu">
                <div class="triangle-decoration"></div>
                <div class="game-title"></div>
                <button class="menu-button" onclick="showTutorial()">Tutorial</button>
                <button class="menu-button" onclick="showGameMenu()">Start Game</button>
                <button class="menu-button" onclick="showGallery()">Gallery</button>
                <button class="menu-button" onclick="showSettings()">Settings</button>
                <button class="menu-button" onclick="exitGame()">Exit</button>
            </div>
        </div>

        <div id="gameMenu" class="screen">
            <button class="back-button" onclick="showMainMenu()">← Back</button>
            <div class="game-menu">
                <h2 style="text-align: center; margin-bottom: 40px;">Select Level</h2>
                <div id="levelList"></div>
            </div>
        </div>

        <div id="gameArea" class="screen">
            <button class="back-button" onclick="backToGameMenu()">← Back</button>
            <div class="hint-icon" id="hintIcon" style="display: none;">
                ?
                <div class="hint-tooltip" id="hintTooltip"></div>
            </div>
            <div class="game-area">
                <div class="table-section">
                    <h2 id="gameTitle" style="margin-bottom: 30px;">Order 4 Group</h2>
                    <div id="multiplicationTable" class="multiplication-table"></div>
                </div>
                <div class="control-panel">
                    <div class="info-section">
                        <strong>Selected Element Info</strong>
                        <div id="elementInfo">
                            Order: -<br>
                            Conjugates: -<br>
                            Centralizer: -
                        </div>
                    </div>
                    <button class="control-button primary" onclick="submitTable()">Submit</button>
                    <button class="control-button" onclick="clearTable()">Clear</button>
                </div>
            </div>
        </div>

        <div id="gallery" class="screen">
            <button class="back-button" onclick="showMainMenu()">← Back</button>
            <div class="gallery">
                <h2>Discovered Groups</h2>
                <div class="gallery-grid" id="galleryGrid"></div>
            </div>
        </div>

        <div id="tutorial" class="screen">
            <button class="back-button" onclick="showMainMenu()">← Back</button>
            <div class="tutorial">
                <h1 style="text-align: center; color: #4ecdc4;">Group Theory Explorer</h1>
                
                <h2>🎯 Objective</h2>
                <p>Fill in multiplication tables to discover and understand finite groups. Master the art of abstract algebra through interactive exploration!</p>
                
                <h2>🔄 Game Flow</h2>
                <p><strong>1. Exploration Mode:</strong> Freely create and explore group structures to discover new groups. This is where you learn and experiment!</p>
                <p><strong>2. Gallery:</strong> View all groups you've discovered in exploration mode. Your personal collection of mathematical achievements.</p>
                <p><strong>3. Puzzle Mode:</strong> Solve challenging puzzles based on groups you've already discovered. Test your understanding!</p>
                
                <h2>🎮 Controls</h2>
                <p>• <strong>Click a cell</strong> to select it</p>
                <p>• <strong>Type numbers (0-9)</strong> to fill values</p>
                <p>• <strong>Backspace/Delete</strong> to clear a cell</p>
                <p>• <strong>Right-click</strong> to quickly clear</p>
                <p>• <strong>Click headers</strong> to swap elements (powerful tool!)</p>
                <p>• <strong>ESC</strong> to return to menu</p>
                
                <h2>📐 Group Properties</h2>
                <p><strong>Closure:</strong> All products must be in the group (no values outside 0 to n-1)</p>
                <p><strong>Associativity:</strong> (a·b)·c = a·(b·c) for all elements</p>
                <p><strong>Identity:</strong> There exists e such that e·a = a·e = a for all a</p>
                <p><strong>Inverses:</strong> For each a, there exists b such that a·b = b·a = e</p>
                
                <h2>💡 Pro Tips</h2>
                <p>• <strong>Start with the identity:</strong> Find which element acts as the identity first</p>
                <p>• <strong>Latin square property:</strong> Each row and column must contain all elements exactly once</p>
                <p>• <strong>Use element swapping:</strong> Click headers to standardize your table - this is crucial for puzzle solving!</p>
                <p>• <strong>Study patterns:</strong> Pay attention to element orders and conjugacy classes</p>
                <p>• <strong>Exploration first:</strong> Discover groups in exploration mode before attempting puzzles</p>
                <p>• <strong>Small groups are easier:</strong> Start with order 4 to understand the basics</p>
            </div>
        </div>

        <div id="settings" class="screen">
            <button class="back-button" onclick="showMainMenu()">← Back</button>
            <div class="settings">
                <h2 style="margin-bottom: 40px;">Settings</h2>
                <div class="setting-item">
                    <span>Enable Screenshots</span>
                    <div class="toggle" id="screenshotToggle" onclick="toggleScreenshot()">
                        <div class="toggle-slider"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span>Language / 语言</span>
                    <select id="languageSelect" onchange="changeLanguage()">
                        <option value="en">English</option>
                        <option value="cn">中文</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Message</h3>
            <p id="modalText"></p>
            <button class="modal-button" onclick="closeModal()">Confirm</button>
        </div>
    </div>

    <script>
        // 游戏状态
        const state = {
            currentPage: 'mainMenu',
            currentMode: 'exploration',
            currentOrder: 4,
            multiTable: [],
            selectedCell: null,
            selectedHeader: null,
            immutableCells: [],
            hint: '',
            language: 'en'
        };

        // 格子展示配置 - 默认为 order - 2 (可在代码中调整)
        function getCellDisplayCount(order) {
            // 你可以在这里修改公式来调整显示的格子数量
            // 默认: order - 2，确保至少显示2个格子
            return Math.max(2, order - 2);
        }

        // 修复后的重新标记群元素函数
        function relabelGroup(table) {
            const order = table.length;
            const permutation = generateRandomPermutation(order);
            const newTable = Array(order).fill(null).map(() => Array(order).fill(0));
            
            // 正确的重新标记：newTable[π(i)][π(j)] = π(table[i][j])
            for (let i = 0; i < order; i++) {
                for (let j = 0; j < order; j++) {
                    const newI = permutation[i];
                    const newJ = permutation[j];
                    const newValue = permutation[table[i][j]];
                    newTable[newI][newJ] = newValue;
                }
            }
            
            return newTable;
        }

        // Robust localStorage parsing function
        function safeJsonParse(key, defaultValue) {
            const item = localStorage.getItem(key);
            if (item === null || item === "null" || item === "undefined") {
                return defaultValue;
            }
            try {
                const parsed = JSON.parse(item);
                if (Array.isArray(defaultValue) && !Array.isArray(parsed)) {
                    console.warn(`Data for key '${key}' in localStorage was not an array, using default.`);
                    return defaultValue;
                }
                if (typeof defaultValue === 'object' && defaultValue !== null && !Array.isArray(defaultValue)) {
                    if (typeof parsed !== 'object' || parsed === null || Array.isArray(parsed)) {
                        console.warn(`Data for key '${key}' in localStorage was not a suitable object, using default.`);
                        return defaultValue;
                    }
                }
                if (key === 'settings' && typeof parsed === 'object' && parsed !== null && typeof defaultValue === 'object' && defaultValue !== null) {
                    return { ...defaultValue, ...parsed };
                }
                return parsed;
            } catch (e) {
                console.warn(`Error parsing JSON for key '${key}' from localStorage, using default value. Error:`, e);
                return defaultValue;
            }
        }

        // 数据存储
        const storage = {
            discoveredGroups: safeJsonParse('discoveredGroups', []),
            solvedPuzzles: safeJsonParse('solvedPuzzles', {}),
            settings: safeJsonParse('settings', {"screenshot": false, "language": "en"})
        };

        // 保存数据
        function saveData() {
            try {
                localStorage.setItem('discoveredGroups', JSON.stringify(storage.discoveredGroups));
                localStorage.setItem('solvedPuzzles', JSON.stringify(storage.solvedPuzzles));
                localStorage.setItem('settings', JSON.stringify(storage.settings));
            } catch (e) {
                console.error("Error saving data to localStorage:", e);
            }
        }

        // 级别配置
        const levelOrders = [4, 6, 8, 9, 10, 12, 14, 15, 16, 18, 20];

        // 群数据库
        const groupsData = {
            1: [{name: '1', description: 'Trivial group'}],
            2: [{name: 'C2', description: 'Cyclic group of order 2'}],
            3: [{name: 'C3', description: 'Cyclic group of order 3'}],
            4: [
                {name: 'C4', description: 'Cyclic group of order 4'},
                {name: 'C2 x C2', description: 'Klein four-group'}
            ],
            5: [{name: 'C5', description: 'Cyclic group of order 5'}],
            6: [
                {name: 'C6', description: 'Cyclic group of order 6'},
                {name: 'S3', description: 'Symmetric group on 3 letters'}
            ],
            8: [
                {name: 'C8', description: 'Cyclic group of order 8'},
                {name: 'C4 x C2', description: 'Direct product'},
                {name: 'C2 x C2 x C2', description: 'Elementary abelian'},
                {name: 'D8', description: 'Dihedral group of order 8'},
                {name: 'Q8', description: 'Quaternion group'}
            ],
            9: [
                {name: 'C9', description: 'Cyclic group of order 9'},
                {name: 'C3 x C3', description: 'Elementary abelian'}
            ],
            10: [
                {name: 'C10', description: 'Cyclic group of order 10'},
                {name: 'D10', description: 'Dihedral group of order 10'}
            ],
            12: [
                {name: 'C12', description: 'Cyclic group of order 12'},
                {name: 'C6 x C2', description: 'Direct product'},
                {name: 'A4', description: 'Alternating group on 4 letters'},
                {name: 'D12', description: 'Dihedral group of order 12'},
                {name: 'C3 : C4', description: 'Semidirect product'}
            ],
            14: [
                {name: 'C14', description: 'Cyclic group of order 14'},
                {name: 'D14', description: 'Dihedral group of order 14'}
            ],
            15: [{name: 'C15', description: 'Cyclic group of order 15'}],
            16: [
                {name: 'C16', description: 'Cyclic group of order 16'},
                {name: 'C8 x C2', description: 'Direct product'},
                {name: 'C4 x C4', description: 'Direct product'},
                {name: 'C4 x C2 x C2', description: 'Direct product'},
                {name: 'C2 x C2 x C2 x C2', description: 'Elementary abelian'},
                {name: 'D16', description: 'Dihedral group of order 16'},
                {name: 'Q16', description: 'Generalized quaternion'},
                {name: 'QD16', description: 'Quasi-dihedral'},
                {name: 'C8 : C2', description: 'Semidirect product'},
                {name: 'C2 x D8', description: 'Direct product'},
                {name: 'C2 x Q8', description: 'Direct product'},
                {name: 'C4 : C4', description: 'Semidirect product'},
                {name: 'G4,4', description: 'Group of order 16'},
                {name: '(C4 x C2) : C2', description: 'Semidirect product'}
            ],
            18: [
                {name: 'C18', description: 'Cyclic group of order 18'},
                {name: 'C6 x C3', description: 'Direct product'},
                {name: 'D18', description: 'Dihedral group of order 18'},
                {name: 'C3 x S3', description: 'Direct product'},
                {name: '(C3 x C3) : C2', description: 'Semidirect product'}
            ],
            20: [
                {name: 'C20', description: 'Cyclic group of order 20'},
                {name: 'C10 x C2', description: 'Direct product'},
                {name: 'D20', description: 'Dihedral group of order 20'},
                {name: 'C5 ⋊ C4', description: 'Semidirect product'},
                {name: 'Fr20', description: 'Frobenius group'}
            ]
        };

        // 改进的puzzle生成函数，使用简化的格子数量计算
        function generatePuzzleFromDiscovered(order, puzzleIndex) {
            const discoveredGroupsOfOrder = storage.discoveredGroups.filter(g => g.order === order && g.table);
            
            if (discoveredGroupsOfOrder.length === 0) {
                return null;
            }
            
            // 根据puzzleIndex选择群（循环使用）
            const selectedGroup = discoveredGroupsOfOrder[puzzleIndex % discoveredGroupsOfOrder.length];
            let groupTable = JSON.parse(JSON.stringify(selectedGroup.table));
            
            // 随机决定是否重新标记元素（50%概率）
            if (Math.random() > 0.5) {
                groupTable = relabelGroup(groupTable);
            }
            
            // 使用简化的格子数量计算
            const targetCells = getCellDisplayCount(order);
            const cellsToShow = selectStrategicCells(groupTable, order, targetCells);
            
            // 生成immutable cells和hint
            const immutableCells = cellsToShow.map(([i, j]) => [i, j, groupTable[i][j]]);
            const hint = generateHint(selectedGroup.name, order);
            
            return {
                cells: immutableCells,
                hint: hint,
                sourceName: selectedGroup.name
            };
        }

        // 战略性地选择要显示的单元格，使用配置的数量
        function selectStrategicCells(table, order, targetCells) {
            const positions = [];
            
            // 总是包含一些关键位置：
            // 1. 对角线上的一些元素（帮助识别单位元）
            for (let i = 0; i < order; i++) {
                if (Math.random() < 0.4 && positions.length < targetCells) { // 40%概率包含对角线元素
                    positions.push([i, i]);
                }
            }
            
            // 2. 第一行和第一列的一些元素（如果包含单位元）
            const identity = findIdentityInTable(table);
            if (identity !== -1) {
                // 包含单位元行的一些元素
                for (let j = 0; j < order && positions.length < targetCells; j++) {
                    if (Math.random() < 0.3 && !positions.some(([r, c]) => r === identity && c === j)) {
                        positions.push([identity, j]);
                    }
                }
                // 包含单位元列的一些元素
                for (let i = 0; i < order && positions.length < targetCells; i++) {
                    if (Math.random() < 0.3 && !positions.some(([r, c]) => r === i && c === identity)) {
                        positions.push([i, identity]);
                    }
                }
            }
            
            // 3. 随机添加更多单元格直到达到目标数量
            const allPositions = [];
            for (let i = 0; i < order; i++) {
                for (let j = 0; j < order; j++) {
                    allPositions.push([i, j]);
                }
            }
            
            // 随机打乱剩余位置
            const remainingPositions = allPositions.filter(([i, j]) => 
                !positions.some(([r, c]) => r === i && c === j)
            );
            shuffleArray(remainingPositions);
            
            // 添加随机位置直到达到目标
            while (positions.length < targetCells && remainingPositions.length > 0) {
                positions.push(remainingPositions.pop());
            }
            
            return positions;
        }

        // 在给定表格中查找单位元
        function findIdentityInTable(table) {
            const order = table.length;
            for (let e = 0; e < order; e++) {
                let isIdentity = true;
                for (let i = 0; i < order; i++) {
                    if (table[e][i] !== i || table[i][e] !== i) {
                        isIdentity = false;
                        break;
                    }
                }
                if (isIdentity) return e;
            }
            return -1;
        }

        // 数组打乱函数
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // 生成随机置换
        function generateRandomPermutation(n) {
            const arr = Array.from({length: n}, (_, i) => i);
            shuffleArray(arr);
            return arr;
        }

        // 改进的提示生成
        function generateHint(groupName, order) {
            const hints = {
                'C4': 'This is a cyclic group. Find the generator element - one element whose powers give all others.',
                'C2 x C2': 'Klein four-group: every non-identity element has order 2. All elements commute.',
                'C6': 'Cyclic group of order 6. Look for the generator element.',
                'S3': 'Symmetric group S3: not all elements commute. Contains 3-cycles and 2-cycles.',
                'C8': 'Cyclic group of order 8. Find the generator element.',
                'D8': 'Dihedral group: contains rotations and reflections. Half the elements have order 2.',
                'D4': 'Dihedral group: contains rotations and reflections.',
                'A4': 'Alternating group: all even permutations on 4 elements. Contains 3-cycles.',
                'Q8': 'Quaternion group: non-abelian, all non-identity elements have order 4.'
            };
            
            const specificHint = hints[groupName];
            if (specificHint) {
                return specificHint;
            }
            
            // 通用提示
            if (groupName.startsWith('C') && !groupName.includes('x')) {
                return `Cyclic group of order ${order}. All elements can be generated by powers of one element.`;
            } else if (groupName.includes('x')) {
                return `Direct product group. Elements behave independently in each component.`;
            } else if (groupName.startsWith('D')) {
                return `Dihedral group of order ${order}. Contains rotations and reflections.`;
            }
            
            return `Complete this group structure of order ${order}. Based on ${groupName}.`;
        }

        // 检查该阶数是否有已发现的群
        function hasDiscoveredGroupsOfOrder(order) {
            return storage.discoveredGroups.some(g => g.order === order && g.table);
        }

        // 获取该阶数已发现的群数量
        function getDiscoveredGroupsCountOfOrder(order) {
            return storage.discoveredGroups.filter(g => g.order === order && g.table).length;
        }

        // 语言系统
        const translations = {
            en: {
                tutorial: 'Tutorial',
                startGame: 'Start Game',
                gallery: 'Gallery',
                settings: 'Settings',
                exit: 'Exit',
                discovered: 'Discovered',
                puzzle: 'Puzzle',
                order: 'Order',
                conjugates: 'Conjugates',
                centralizer: 'Centralizer',
                submit: 'Submit',
                clear: 'Clear',
                back: 'Back',
                selectLevel: 'Select Level',
                discoveredGroups: 'Discovered Groups',
                enableScreenshots: 'Enable Screenshots',
                language: 'Language',
                congratulations: 'Congratulations!',
                thisGroupIs: 'This group is',
                validGroup: 'You have successfully created a valid group!',
                youveDiscoveredBefore: "You've discovered it before.",
                notAGroup: 'This is not a valid group. Check the group axioms.',
                fillTable: 'Please fill in the entire table first.',
                hintTooltip: 'Click to see hint',
                message: 'Message',
                noPuzzlesAvailable: 'No puzzles available - discover groups first in exploration mode!',
                noPuzzlesHint: 'Complete groups in exploration mode to unlock puzzles for this order.',
                puzzleCompleted: 'Puzzle completed successfully!'
            },
            cn: {
                tutorial: '游戏说明',
                startGame: '开始游戏',
                gallery: '画廊',
                settings: '设置',
                exit: '退出',
                discovered: '已发现',
                puzzle: '谜题',
                order: '阶',
                conjugates: '共轭元',
                centralizer: '中心化子',
                submit: '提交',
                clear: '清空',
                back: '返回',
                selectLevel: '选择关卡',
                discoveredGroups: '已发现的群',
                enableScreenshots: '启用截图',
                language: '语言 / Language',
                congratulations: '恭喜！',
                thisGroupIs: '这个群是',
                validGroup: '你成功创建了一个有效的群！',
                youveDiscoveredBefore: '你之前已经发现过它了。',
                notAGroup: '这不是一个有效的群。请检查群公理。',
                fillTable: '请先填满整个表格。',
                hintTooltip: '点击查看提示',
                message: '消息',
                noPuzzlesAvailable: '无可用谜题 - 请先在探索模式中发现群！',
                noPuzzlesHint: '在探索模式中完成群以解锁此阶数的谜题。',
                puzzleCompleted: '谜题完成成功！'
            }
        };

        function t(key) {
            return translations[state.language][key] || key;
        }

        // 初始化
        function init() {
            // 加载设置
            state.language = storage.settings.language || 'en';
            
            const screenshotToggle = document.getElementById('screenshotToggle');
            if (screenshotToggle) screenshotToggle.classList.toggle('on', storage.settings.screenshot);

            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) languageSelect.value = state.language;
            
            // 更新文本
            updateLanguage();
        }

        // 页面切换
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            const screenToShow = document.getElementById(screenId);
            if (screenToShow) {
                 screenToShow.classList.add('active');
            } else {
                console.error("Screen not found: " + screenId);
                document.getElementById('mainMenu').classList.add('active');
            }
            state.currentPage = screenId;
        }

        function showMainMenu() {
            showScreen('mainMenu');
        }

        function showGameMenu() {
            generateLevelList();
            showScreen('gameMenu');
        }

        function showGallery() {
            updateGallery();
            showScreen('gallery');
        }

        function showTutorial() {
            showScreen('tutorial');
        }

        function showSettings() {
            showScreen('settings');
        }

        function exitGame() {
            if (confirm('Are you sure you want to exit?')) {
                window.close();
            }
        }

        function backToGameMenu() {
            showGameMenu();
        }

        // 生成关卡列表
        function generateLevelList() {
            const levelList = document.getElementById('levelList');
            if (!levelList) return;
            levelList.innerHTML = '';
            
            levelOrders.forEach(order => {
                const discovered = Array.isArray(storage.discoveredGroups) ? storage.discoveredGroups.filter(g => g.order === order).length : 0;
                const total = groupsData[order]?.length || 0;
                const solvedPuzzles = (typeof storage.solvedPuzzles === 'object' && storage.solvedPuzzles !== null && storage.solvedPuzzles[order]) ? storage.solvedPuzzles[order] : 0;
                
                // 检查是否有已发现的群可以用于puzzle
                const hasDiscoveredGroups = hasDiscoveredGroupsOfOrder(order);
                const discoveredGroupsCount = getDiscoveredGroupsCountOfOrder(order);
                
                const row = document.createElement('div');
                row.className = 'level-row';
                
                let puzzleButtonContent;
                let puzzleButtonClass = 'level-button';
                let puzzleButtonOnClick = `startPuzzle(${order})`;
                
                if (hasDiscoveredGroups) {
                    puzzleButtonContent = `${t('puzzle')} ${solvedPuzzles}/${discoveredGroupsCount}`;
                } else {
                    puzzleButtonContent = t('noPuzzlesAvailable');
                    puzzleButtonClass += ' disabled';
                    puzzleButtonOnClick = 'return false;';
                }
                
                row.innerHTML = `
                    <div class="level-label">${t('order')} ${order}</div>
                    <div class="level-buttons">
                        <button class="level-button" onclick="startExploration(${order})">
                            ${t('discovered')} ${discovered}/${total}
                        </button>
                        <button class="${puzzleButtonClass}" onclick="${puzzleButtonOnClick}">
                            ${puzzleButtonContent}
                        </button>
                    </div>
                `;
                
                // 如果没有已发现的群，添加提示
                if (!hasDiscoveredGroups) {
                    const hint = document.createElement('div');
                    hint.className = 'no-groups-hint';
                    hint.textContent = t('noPuzzlesHint');
                    row.appendChild(hint);
                }
                
                levelList.appendChild(row);
            });
        }

        // 开始探索模式
        function startExploration(order) {
            state.currentMode = 'exploration';
            state.currentOrder = order;
            state.immutableCells = [];
            initTable();
            const gameTitleEl = document.getElementById('gameTitle');
            if(gameTitleEl) gameTitleEl.textContent = `${t('order')} ${order} Group`;
            const hintIconEl = document.getElementById('hintIcon');
            if(hintIconEl) hintIconEl.style.display = 'none';
            showScreen('gameArea');
        }

        // 开始谜题模式
        function startPuzzle(order) {
            // 检查是否有已发现的群
            if (!hasDiscoveredGroupsOfOrder(order)) {
                showModal(t('noPuzzlesAvailable'));
                return;
            }
            
            state.currentMode = 'puzzle';
            state.currentOrder = order;
            initTable();
            
            const solvedCount = (typeof storage.solvedPuzzles === 'object' && storage.solvedPuzzles !== null && storage.solvedPuzzles[order]) ? storage.solvedPuzzles[order] : 0;
            
            // 使用改进的puzzle生成系统
            const puzzle = generatePuzzleFromDiscovered(order, solvedCount);
            
            if (!puzzle) {
                showModal(t('noPuzzlesAvailable'));
                return;
            }
            
            state.immutableCells = [];
            if (puzzle.cells && Array.isArray(puzzle.cells)) {
                puzzle.cells.forEach(([i, j, value]) => {
                    if (i < state.currentOrder && j < state.currentOrder) {
                       state.multiTable[i][j] = value;
                       state.immutableCells.push([i, j]);
                    }
                });
            }
            
            state.hint = puzzle.hint || '';
            const hintTooltipEl = document.getElementById('hintTooltip');
            if (hintTooltipEl) hintTooltipEl.textContent = state.hint;
            
            const gameTitleEl = document.getElementById('gameTitle');
            if(gameTitleEl) gameTitleEl.textContent = `${t('order')} ${order} ${t('puzzle')}`;
            const hintIconEl = document.getElementById('hintIcon');
            if(hintIconEl) hintIconEl.style.display = 'block';
            
            renderTable();
            showScreen('gameArea');
        }

        // 初始化表格
        function initTable() {
            state.multiTable = Array(state.currentOrder).fill(null).map(() => Array(state.currentOrder).fill(-1));
            state.selectedCell = null;
            state.selectedHeader = null;
            renderTable();
        }

        // 渲染表格
        function renderTable() {
            const container = document.getElementById('multiplicationTable');
            if (!container) return;
            container.innerHTML = '';
            container.style.gridTemplateColumns = `repeat(${state.currentOrder + 1}, 45px)`;
            
            // 空角落
            const corner = document.createElement('div');
            corner.className = 'cell header';
            corner.style.background = 'rgba(40, 40, 60, 0.8)';
            container.appendChild(corner);
            
            // 列头
            for (let i = 0; i < state.currentOrder; i++) {
                const header = document.createElement('div');
                header.className = 'cell header';
                if (state.selectedHeader === i) header.classList.add('selected');
                header.textContent = i;
                header.style.background = getElementColor(i, 180);
                header.onclick = () => selectHeader(i);
                container.appendChild(header);
            }
            
            // 行
            for (let i = 0; i < state.currentOrder; i++) {
                // 行头
                const rowHeader = document.createElement('div');
                rowHeader.className = 'cell header';
                if (state.selectedHeader === i) rowHeader.classList.add('selected');
                rowHeader.textContent = i;
                rowHeader.style.background = getElementColor(i, 180);
                rowHeader.onclick = () => selectHeader(i);
                container.appendChild(rowHeader);
                
                // 单元格
                for (let j = 0; j < state.currentOrder; j++) {
                    const cell = document.createElement('div');
                    cell.className = 'cell';
                    
                    const value = state.multiTable[i][j];
                    if (value >= 0 && value < state.currentOrder) {
                        cell.textContent = value;
                        cell.style.background = getElementColor(value);
                        cell.style.color = '#fff';
                    } else {
                         cell.textContent = '';
                         cell.style.background = 'rgba(40, 40, 60, 0.6)';
                    }
                    
                    if (state.immutableCells.some(([r, c]) => r === i && c === j)) {
                        cell.classList.add('immutable');
                    } else {
                        if (state.selectedCell && state.selectedCell[0] === i && state.selectedCell[1] === j) {
                            cell.classList.add('selected');
                        }
                        cell.onclick = () => selectCell(i, j);
                        cell.oncontextmenu = (e) => {
                            e.preventDefault();
                            clearCell(i, j);
                        };
                    }
                    
                    container.appendChild(cell);
                }
            }
        }

        // 改进的颜色生成函数
        function getElementColor(element, lightness = 200) {
            if (element === -1 || element >= state.currentOrder) return 'rgba(40, 40, 60, 0.6)';
            
            const order = state.currentOrder;
            if (order === 0) return 'rgba(40, 40, 60, 0.6)';
            
            // 使用更丰富的颜色调色板
            const colors = [
                '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57',
                '#ff9ff3', '#54a0ff', '#5f27cd', '#00d2d3', '#ff9f43',
                '#10ac84', '#ee5253', '#0abde3', '#feca57', '#48dbfb',
                '#ff3838', '#1dd1a1', '#ffd32a', '#ff3838', '#3742fa'
            ];
            
            return colors[element % colors.length];
        }

        // 选择表头
        function selectHeader(index) {
            if (state.selectedHeader !== null && state.selectedHeader !== index) {
                swapElements(state.selectedHeader, index);
                state.selectedHeader = null;
            } else {
                state.selectedHeader = index;
            }
            renderTable();
        }

        // 交换元素
        function swapElements(elem1, elem2) {
            if (elem1 === elem2 || elem1 < 0 || elem1 >= state.currentOrder || elem2 < 0 || elem2 >= state.currentOrder) return;
            
            const newTable = state.multiTable.map(row => [...row]);
            
            // 交换行
            [newTable[elem1], newTable[elem2]] = [newTable[elem2], newTable[elem1]];
            
            // 交换列
            for (let i = 0; i < state.currentOrder; i++) {
                [newTable[i][elem1], newTable[i][elem2]] = [newTable[i][elem2], newTable[i][elem1]];
            }
            
            // 更新值
            for (let i = 0; i < state.currentOrder; i++) {
                for (let j = 0; j < state.currentOrder; j++) {
                    if (newTable[i][j] === elem1) newTable[i][j] = -2;
                    else if (newTable[i][j] === elem2) newTable[i][j] = elem1;
                }
            }
             for (let i = 0; i < state.currentOrder; i++) {
                for (let j = 0; j < state.currentOrder; j++) {
                    if (newTable[i][j] === -2) newTable[i][j] = elem2;
                }
            }
            
            state.multiTable = newTable;
            
            // 更新不可变单元格位置
            state.immutableCells = state.immutableCells.map(([r, c]) => {
                let newR = r;
                let newC = c;
                if (r === elem1) newR = elem2; else if (r === elem2) newR = elem1;
                if (c === elem1) newC = elem2; else if (c === elem2) newC = elem1;
                return [newR, newC];
            });
        }

        // 选择单元格
        function selectCell(row, col) {
            state.selectedCell = [row, col];
            state.selectedHeader = null;
            renderTable();
            updateElementInfo();
        }

        // 清除单元格
        function clearCell(row, col) {
            if (state.immutableCells.some(([r, c]) => r === row && c === col)) return;
            state.multiTable[row][col] = -1;
            renderTable();
        }

        // 更新元素信息
        function updateElementInfo() {
            const elementInfoEl = document.getElementById('elementInfo');
            if (!elementInfoEl) return;

            if (!state.selectedCell) {
                 elementInfoEl.innerHTML = `${t('order')}: -<br>${t('conjugates')}: -<br>${t('centralizer')}: -`;
                 return;
            }
            
            const [row, col] = state.selectedCell;
            const value = state.multiTable[row][col];
            
            if (value >= 0 && value < state.currentOrder) {
                const order = calculateOrder(value);
                const conjugates = calculateConjugates(value);
                const centralizer = calculateCentralizer(value);
                
                elementInfoEl.innerHTML = `
                    ${t('order')}: ${order === null ? '-' : order}<br>
                    ${t('conjugates')}: ${conjugates.length > 0 ? conjugates.join(', ') : '-'}<br>
                    ${t('centralizer')}: ${centralizer.length > 0 ? centralizer.join(', ') : '-'}
                `;
            } else {
                 elementInfoEl.innerHTML = `${t('order')}: -<br>${t('conjugates')}: -<br>${t('centralizer')}: -`;
            }
        }

        // 计算元素的阶
        function calculateOrder(element) {
            if (element < 0 || element >= state.currentOrder) return null;
            const identity = findIdentity();
            if (identity === -1) return null;
            if (element === identity) return 1;
            
            let currentElement = element;
            for (let i = 2; i <= state.currentOrder; i++) {
                currentElement = multiply(currentElement, element);
                if (currentElement === -1) return null;
                if (currentElement === identity) return i;
            }
            return null;
        }

        // 计算共轭元
        function calculateConjugates(element) {
            if (element < 0 || element >= state.currentOrder) return [];
            const conjugates = new Set([element]);
            const identity = findIdentity();
            if (identity === -1) return [element];
            
            for (let g = 0; g < state.currentOrder; g++) {
                const gInv = findInverse(g);
                if (gInv === -1) continue;
                
                const g_x_element = multiply(g, element);
                if (g_x_element === -1) continue;
                const conjugate = multiply(g_x_element, gInv);
                
                if (conjugate !== -1 && conjugate < state.currentOrder) {
                    conjugates.add(conjugate);
                }
            }
            
            return Array.from(conjugates).sort((a, b) => a - b);
        }

        // 计算中心化子
        function calculateCentralizer(element) {
            if (element < 0 || element >= state.currentOrder) return [];
            const centralizer = [];
            
            for (let g = 0; g < state.currentOrder; g++) {
                const g_x_element = multiply(g, element);
                const element_x_g = multiply(element, g);
                
                if (g_x_element !== -1 && element_x_g !== -1 && g_x_element === element_x_g) {
                    centralizer.push(g);
                }
            }
            
            return centralizer.sort((a,b) => a - b);
        }

        // 查找单位元
        function findIdentity() {
            for (let e = 0; e < state.currentOrder; e++) {
                let isIdentity = true;
                for (let i = 0; i < state.currentOrder; i++) {
                    if (multiply(e, i) !== i || multiply(i, e) !== i) {
                        isIdentity = false;
                        break;
                    }
                }
                if (isIdentity) return e;
            }
            return -1;
        }

        // 查找逆元
        function findInverse(element) {
            if (element < 0 || element >= state.currentOrder) return -1;
            const identity = findIdentity();
            if (identity === -1) return -1;
            
            for (let i = 0; i < state.currentOrder; i++) {
                if (multiply(element, i) === identity && multiply(i, element) === identity) {
                    return i;
                }
            }
            return -1;
        }

        // 乘法运算
        function multiply(a, b) {
            if (a < 0 || a >= state.currentOrder || b < 0 || b >= state.currentOrder) return -1;
            if (!state.multiTable || !state.multiTable[a]) return -1;
            const result = state.multiTable[a][b];
            if (result < 0 || result >= state.currentOrder) return -1;
            return result;
        }

        // 键盘输入
        document.addEventListener('keydown', (e) => {
            if (state.currentPage !== 'gameArea') return;
            
            if (e.key === 'Escape') {
                backToGameMenu();
                return;
            }
            
            if (!state.selectedCell) return;
            
            const [row, col] = state.selectedCell;
            if (state.immutableCells.some(([r, c]) => r === row && c === col)) return;
            
            if (e.key >= '0' && e.key <= '9') {
                const digit = parseInt(e.key);
                if (digit >= state.currentOrder) return; 
                
                state.multiTable[row][col] = digit;
                renderTable();
                updateElementInfo();

            } else if (e.key === 'Backspace' || e.key === 'Delete') {
                clearCell(row, col);
            }
        });

        // 提交表格
        function submitTable() {
            // 检查是否填满
            for (let i = 0; i < state.currentOrder; i++) {
                for (let j = 0; j < state.currentOrder; j++) {
                    if (state.multiTable[i][j] === -1 || state.multiTable[i][j] >= state.currentOrder) {
                        showModal(t('fillTable'));
                        return;
                    }
                }
            }
            
            // 验证群
            if (isValidGroup()) {
                const groupName = identifyGroup();
                
                // 添加成功动画
                const tableElement = document.getElementById('multiplicationTable');
                if (tableElement) {
                    tableElement.classList.add('celebrate');
                    setTimeout(() => tableElement.classList.remove('celebrate'), 600);
                }
                
                // 探索模式：记录发现的新群
                if (state.currentMode === 'exploration') {
                    if (!storage.discoveredGroups.some(g => g.name === groupName && g.order === state.currentOrder)) {
                        storage.discoveredGroups.push({
                            name: groupName, 
                            order: state.currentOrder, 
                            table: JSON.parse(JSON.stringify(state.multiTable))
                        });
                        showModal(`${t('congratulations')}<br>${t('thisGroupIs')} <strong>${groupName}</strong>`);
                    } else {
                        showModal(`${t('congratulations')}<br>${t('validGroup')}<br><em>(${t('youveDiscoveredBefore')})</em>`);
                    }
                    saveData();
                }
                // 谜题模式：任何有效群都算成功
                else if (state.currentMode === 'puzzle') {
                    if (typeof storage.solvedPuzzles !== 'object' || storage.solvedPuzzles === null) storage.solvedPuzzles = {};
                    storage.solvedPuzzles[state.currentOrder] = (storage.solvedPuzzles[state.currentOrder] || 0) + 1;
                    saveData();
                    showModal(`🎉 ${t('puzzleCompleted')}<br>${t('thisGroupIs')} <strong>${groupName}</strong>`);
                }
            } else {
                showModal(`❌ ${t('notAGroup')}`);
            }
        }

        // 验证是否为群
        function isValidGroup() {
            if (state.currentOrder === 0) return false;

            // 1. 找到单位元
            const identity = findIdentity();
            if (identity === -1) return false;

            // 2. 检查逆元
            for (let i = 0; i < state.currentOrder; i++) {
                if (findInverse(i) === -1) return false;
            }
            
            // 3. 检查结合律
            for (let a = 0; a < state.currentOrder; a++) {
                for (let b = 0; b < state.currentOrder; b++) {
                    for (let c = 0; c < state.currentOrder; c++) {
                        const ab = multiply(a,b);
                        if (ab === -1) return false;
                        const ab_c = multiply(ab, c);
                        
                        const bc = multiply(b,c);
                        if (bc === -1) return false;
                        const a_bc = multiply(a, bc);

                        if (ab_c === -1 || a_bc === -1 || ab_c !== a_bc) return false;
                    }
                }
            }
            
            // 4. 拉丁方性质
            for (let i = 0; i < state.currentOrder; i++) {
                const rowSet = new Set();
                const colSet = new Set();
                for (let j = 0; j < state.currentOrder; j++) {
                    rowSet.add(state.multiTable[i][j]);
                    colSet.add(state.multiTable[j][i]);
                }
                if (rowSet.size !== state.currentOrder || colSet.size !== state.currentOrder) {
                    return false;
                }
            }
            
            return true;
        }
        
        // 识别群
        function identifyGroup() {
            const order = state.currentOrder;
            
            let isAbelian = true;
            for (let i = 0; i < order; i++) {
                for (let j = 0; j < order; j++) {
                    if (multiply(i,j) !== multiply(j,i)) {
                        isAbelian = false;
                        break;
                    }
                }
                if (!isAbelian) break;
            }
            
            if (isPrime(order)) return `C${order}`;
            
            switch (order) {
                case 1: return '1';
                case 2: return 'C2';
                case 3: return 'C3';
                case 4:
                    return isAbelian && hasElementOfOrder(4) ? 'C4' : 'C2 x C2';
                case 5: return 'C5';
                case 6:
                    return isAbelian ? 'C6' : 'S3';
                case 8:
                    if (isAbelian) {
                        if (hasElementOfOrder(8)) return 'C8';
                        if (hasElementOfOrder(4)) return 'C4 x C2';
                        return 'C2 x C2 x C2';
                    } else {
                        // 区分二面体群和四元数群需要更复杂的分析
                        return countElementsOfOrder(2) > 1 ? 'D8' : 'Q8';
                    }
                case 9:
                    return hasElementOfOrder(9) ? 'C9' : 'C3 x C3';
                case 10:
                    return isAbelian ? 'C10' : 'D10';
                default:
                    const knownGroupsForOrder = groupsData[order];
                    if (knownGroupsForOrder) {
                        if (isAbelian) {
                            const abelianMatch = knownGroupsForOrder.find(g => g.name.startsWith('C') || g.name.includes('x'));
                            if (abelianMatch) return abelianMatch.name;
                        } else {
                             const nonAbelianMatch = knownGroupsForOrder.find(g => !g.name.startsWith('C') && !g.name.includes('x'));
                             if (nonAbelianMatch) return nonAbelianMatch.name;
                        }
                    }
                    return `${isAbelian ? "Abelian" : "Non-Abelian"} Group of order ${order}`;
            }
        }
        
        function isPrime(n) {
            if (n <= 1) return false;
            if (n <= 3) return true;
            if (n % 2 === 0 || n % 3 === 0) return false;
            for (let i = 5; i * i <= n; i = i + 6) {
                if (n % i === 0 || n % (i + 2) === 0) return false;
            }
            return true;
        }
        
        function hasElementOfOrder(ord) {
            for (let g = 0; g < state.currentOrder; g++) {
                if (calculateOrder(g) === ord) return true;
            }
            return false;
        }

        function countElementsOfOrder(ord) {
            let count = 0;
            for (let g = 0; g < state.currentOrder; g++) {
                if (calculateOrder(g) === ord) count++;
            }
            return count;
        }

        // 清空表格
        function clearTable() {
            if (confirm(t('clear') + '?')) {
                for(let i=0; i<state.currentOrder; i++) {
                    for(let j=0; j<state.currentOrder; j++) {
                        if (!state.immutableCells.some(([r, c]) => r === i && c === j)) {
                            state.multiTable[i][j] = -1;
                        }
                    }
                }
                state.selectedCell = null;
                renderTable();
                updateElementInfo();
            }
        }

        // 更新画廊
        function updateGallery() {
            const grid = document.getElementById('galleryGrid');
            if (!grid) return;
            grid.innerHTML = '';
            
            const knownOrders = Object.keys(groupsData).map(Number).sort((a,b) => a-b);

            knownOrders.forEach(order => {
                 const groupsForOrder = groupsData[order] || [];
                 groupsForOrder.forEach(groupInfo => {
                    const discovered = Array.isArray(storage.discoveredGroups) && storage.discoveredGroups.some(g => g.name === groupInfo.name && g.order === order);
                    
                    const card = document.createElement('div');
                    if (discovered) {
                        card.className = 'group-card';
                        const discoveredGroupData = storage.discoveredGroups.find(g => g.name === groupInfo.name && g.order === order);
                        const previewTable = discoveredGroupData && discoveredGroupData.table ? 
                                             generatePreviewTableFromData(discoveredGroupData.table) : 
                                             generatePlaceholderPreviewTable(order);

                        card.innerHTML = `
                            <div class="group-info">
                                <h3>${groupInfo.name}</h3>
                                <div class="order">${t('order')} ${order}</div>
                                <div class="description">${groupInfo.description || 'No description.'}</div>
                            </div>
                            <div class="group-table-preview" style="grid-template-columns: repeat(${Math.min(order, 8)}, 1fr); grid-template-rows: repeat(${Math.min(order, 8)}, 1fr);">
                                ${previewTable}
                            </div>
                        `;
                    } else {
                        card.className = 'group-card unknown';
                        card.innerHTML = `
                            <div>?</div>
                            <div style="font-size: 14px; margin-top: 10px; color: #888;">
                                <strong>${groupInfo.name}</strong><br>
                                ${t('order')} ${order}
                            </div>
                        `;
                    }
                    grid.appendChild(card);
                });
            });
        }
        
        function generatePreviewTableFromData(tableData) {
            if (!tableData || !Array.isArray(tableData)) return generatePlaceholderPreviewTable(1);
            const order = tableData.length;
            const maxShow = Math.min(order, 8);
            let html = '';
            for (let i = 0; i < maxShow; i++) {
                for (let j = 0; j < maxShow; j++) {
                    const val = tableData[i][j];
                    const color = (val >= 0 && val < order) ? getElementColor(val, 120) : 'rgba(60, 60, 80, 0.8)';
                    html += `<div class="preview-cell" style="background: ${color}; color: #fff;">${(val >= 0 && val < order && order <= 8) ? val : ''}</div>`;
                }
            }
            return html;
        }

        function generatePlaceholderPreviewTable(order) {
            const maxShow = Math.min(order, 8);
            let html = '';
            for (let i = 0; i < maxShow; i++) {
                for (let j = 0; j < maxShow; j++) {
                    const color = getElementColor((i * maxShow + j) % order, 80); 
                    html += `<div class="preview-cell" style="background: ${color}; opacity: 0.3;"></div>`;
                }
            }
            return html;
        }

        // 显示消息
        function showModal(message, title = t('message')) {
            const modalTitleEl = document.getElementById('modalTitle');
            const modalTextEl = document.getElementById('modalText');
            const modalEl = document.getElementById('modal');

            if (modalTitleEl) modalTitleEl.textContent = title;
            if (modalTextEl) modalTextEl.innerHTML = message;
            if (modalEl) modalEl.classList.add('active');
        }

        function closeModal() {
            const modalEl = document.getElementById('modal');
            if (modalEl) modalEl.classList.remove('active');
        }

        // 设置功能
        function toggleScreenshot() {
            if (typeof storage.settings !== 'object' || storage.settings === null) storage.settings = {};
            storage.settings.screenshot = !storage.settings.screenshot;
            const screenshotToggleEl = document.getElementById('screenshotToggle');
            if (screenshotToggleEl) screenshotToggleEl.classList.toggle('on', storage.settings.screenshot);
            saveData();
        }

        function changeLanguage() {
            const languageSelect = document.getElementById('languageSelect');
            if (!languageSelect) return;

            state.language = languageSelect.value;
            if (typeof storage.settings !== 'object' || storage.settings === null) storage.settings = {};
            storage.settings.language = state.language;
            saveData();
            updateLanguage();
            if (state.currentPage === 'gameMenu') generateLevelList();
            if (state.currentPage === 'gameArea') {
                const gameTitleEl = document.getElementById('gameTitle');
                if (gameTitleEl) {
                    if (state.currentMode === 'puzzle') {
                        gameTitleEl.textContent = `${t('order')} ${state.currentOrder} ${t('puzzle')}`;
                    } else {
                        gameTitleEl.textContent = `${t('order')} ${state.currentOrder} Group`;
                    }
                }
                updateElementInfo();
            }
        }

        function updateLanguage() {
            // Main Menu Buttons
            const mainMenuButtons = document.querySelectorAll('#mainMenu .menu-button');
            if (mainMenuButtons.length >= 5) {
                mainMenuButtons[0].textContent = t('tutorial');
                mainMenuButtons[1].textContent = t('startGame');
                mainMenuButtons[2].textContent = t('gallery');
                mainMenuButtons[3].textContent = t('settings');
                mainMenuButtons[4].textContent = t('exit');
            }

            // Back Buttons
            document.querySelectorAll('.back-button').forEach(btn => btn.textContent = `← ${t('back')}`);
            
            // Game Menu
            const gameMenuTitle = document.querySelector('#gameMenu h2');
            if (gameMenuTitle) gameMenuTitle.textContent = t('selectLevel');

            // Game Area
            const gameAreaSubmit = document.querySelector('#gameArea .control-button.primary');
            if (gameAreaSubmit) gameAreaSubmit.textContent = t('submit');
            const gameAreaClear = document.querySelectorAll('#gameArea .control-button')[1];
            if (gameAreaClear) gameAreaClear.textContent = t('clear');
            const selectedInfoStrong = document.querySelector('.info-section strong');
            if(selectedInfoStrong) selectedInfoStrong.textContent = t('Selected Element Info') || "Selected Element Info";

            // Gallery
            const galleryTitle = document.querySelector('#gallery h2');
            if (galleryTitle) galleryTitle.textContent = t('discoveredGroups');

            // Settings
            const settingsTitle = document.querySelector('#settings h2');
            if (settingsTitle) settingsTitle.textContent = t('settings');
            const settingItems = document.querySelectorAll('.setting-item span');
            if (settingItems.length >= 2) {
                settingItems[0].textContent = t('enableScreenshots');
                settingItems[1].textContent = t('language');
            }
            
            const modalButton = document.querySelector('.modal-button');
            if (modalButton) modalButton.textContent = t('Confirm') || 'Confirm';

            if (state.currentPage === 'gameArea') {
                updateElementInfo();
                const gameTitleEl = document.getElementById('gameTitle');
                if (gameTitleEl) {
                    if (state.currentMode === 'puzzle') {
                        gameTitleEl.textContent = `${t('order')} ${state.currentOrder} ${t('puzzle')}`;
                    } else {
                        gameTitleEl.textContent = `${t('order')} ${state.currentOrder} Group`;
                    }
                }
            }
            if(state.currentPage === 'gallery') updateGallery();
            if(state.currentPage === 'gameMenu') generateLevelList();
        }

        // 初始化游戏
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
