<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Math Challenge Game - Mobile Optimized</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;700&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-bg: #0a0a0f;
            --secondary-bg: #1a1a2e;
            --tertiary-bg: #16213e;
            --accent-blue: #00d4ff;
            --accent-purple: #7c3aed;
            --accent-gold: #fbbf24;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #64748b;
            --border-color: #334155;
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--primary-bg) 0%, #0f172a 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 0.5rem;
            overflow-x: hidden;
            position: relative;
            -webkit-overflow-scrolling: touch;
        }
        
        .background-particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }
        .particle {
            position: absolute;
            width: 2px;
            height: 2px;
            background: var(--accent-blue);
            border-radius: 50%;
            opacity: 0.3;
            animation: float 6s infinite ease-in-out;
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) rotate(0deg); opacity: 0.3; }
            50% { transform: translateY(-20px) rotate(180deg); opacity: 0.8; }
        }
        
        .game-container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1rem;
            padding: 0.5rem;
        }
        
        .main-game {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 0.75rem;
        }
        .stat-card {
            background: linear-gradient(135deg, var(--secondary-bg), var(--tertiary-bg));
            border-radius: 0.75rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            min-height: 70px;
        }
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }
        .stat-card:hover::before {
            transform: scaleX(1);
        }
        .stat-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }
        .stat-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-gold);
        }
        .hearts {
            font-size: 1rem;
            filter: drop-shadow(0 0 8px rgba(239, 68, 68, 0.6));
        }
        .heart {
            display: inline-block;
            animation-fill-mode: both;
        }
        .heart.pop {
            animation: heartPop 0.6s ease-out;
        }
        @keyframes heartPop {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.3); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        .round-mode {
            font-size: 0.7rem;
            color: var(--accent-blue);
            margin-top: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
        }
        
        .game-area {
            background: linear-gradient(135deg, var(--secondary-bg), var(--tertiary-bg));
            border-radius: 1rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        .game-title {
            text-align: center;
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            text-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
        }
        .title-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        .help-btn {
            background: linear-gradient(135deg, var(--accent-gold), var(--warning));
            color: var(--primary-bg);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(251, 191, 36, 0.3);
            min-width: 44px;
            min-height: 44px;
        }
        .help-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(251, 191, 36, 0.5);
        }
        .question-text {
            text-align: center;
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
            font-weight: 400;
            line-height: 1.5;
        }
        
        .expressions-container {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1.5rem;
            flex: 1;
        }
        .vs-text {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--accent-gold);
            text-align: center;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(251, 191, 36, 0.05));
            border-radius: 0.75rem;
            border: 1px solid rgba(251, 191, 36, 0.3);
            text-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.05); opacity: 1; }
        }
        
        .expression-btn {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            background: linear-gradient(135deg, var(--tertiary-bg), var(--secondary-bg));
            color: var(--text-primary);
            border: 2px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            min-height: 140px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            line-height: 1.5;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
            min-width: 44px;
        }
        .expression-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(124, 58, 237, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .expression-btn:hover:not(.disabled)::before {
            opacity: 1;
        }
        .expression-btn:hover:not(.disabled) {
            transform: translateY(-2px) scale(1.02);
            border-color: var(--accent-blue);
            box-shadow: 0 8px 25px rgba(0, 212, 255, 0.3);
        }
        .expression-btn:active:not(.disabled) {
            transform: translateY(-1px) scale(1.01);
        }
        .expression-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            filter: grayscale(1);
        }
        .expression-btn.tool-hint-larger {
            border-color: var(--success) !important;
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(34, 197, 94, 0.1)) !important;
        }
        .expression-btn.tool-hint-smaller {
            border-color: var(--error) !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1)) !important;
        }
        .expression-btn.tool-hint-equal {
            border-color: var(--warning) !important;
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1)) !important;
        }

        .math-expression {
            display: inline-block;
            font-family: 'Fira Code', monospace;
            font-size: 1rem;
            line-height: 1.4;
            word-break: break-word;
        }
        .math-fraction {
            display: inline-flex;
            flex-direction: column;
            align-items: center;
            margin: 0 0.2em;
            vertical-align: middle;
        }
        .math-numerator, .math-denominator {
            display: block;
            padding: 0.1em 0.2em;
        }
        .math-denominator {
            border-top: 2px solid currentColor;
        }
        .math-power {
            font-size: 0.7em;
            vertical-align: super;
            margin-left: 0.1em;
        }
        .math-log-base {
            font-size: 0.65em;
            vertical-align: sub;
            margin-right: 0.1em;
        }
        .math-root-index {
            font-size: 0.6em;
            vertical-align: super;
            margin-right: -0.2em;
            position: relative;
            top: -0.4em;
            left: 0.1em;
        }
        .math-sqrt-symbol {
            font-size: 1.2em;
            vertical-align: middle;
            margin-right: 0.1em;
        }
        .math-sum-symbol {
            font-size: 1.4em;
            vertical-align: middle;
            margin-right: 0.15em;
        }
        .math-sum-limits {
            display: inline-flex;
            flex-direction: column;
            font-size: 0.6em;
            vertical-align: middle;
            text-align: center;
            margin-left: -0.25em;
        }
        .math-parentheses {
            font-size: 1.1em;
            margin: 0 0.1em;
            vertical-align: middle;
        }
        .math-brackets {
            font-size: 1.2em;
            margin: 0 0.1em;
            vertical-align: middle;
            font-weight: bold;
        }

        .feedback-area {
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            margin-bottom: 1rem;
            border-radius: 0.75rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 1rem;
        }
        .feedback-text {
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            line-height: 1.4;
        }
        .feedback-text.correct {
            color: var(--success);
            text-shadow: 0 0 15px rgba(34, 197, 94, 0.5);
            animation: bounceIn 0.6s ease;
        }
        .feedback-text.incorrect {
            color: var(--error);
            text-shadow: 0 0 15px rgba(239, 68, 68, 0.5);
            animation: shake 0.6s ease;
        }
        .feedback-text.game-over {
            color: var(--warning);
            font-family: 'JetBrains Mono', monospace;
            text-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            animation: zoomIn 0.8s ease;
        }
        @keyframes bounceIn {
            0% { transform: scale(0.3); opacity: 0; }
            50% { transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        @keyframes zoomIn {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .correct-answer-display {
            font-size: 0.9rem;
            color: var(--text-muted);
            text-align: center;
            line-height: 1.4;
            font-family: 'Fira Code', monospace;
            word-break: break-word;
        }
        .tool-feedback-area {
            min-height: 40px;
            font-size: 0.9rem;
            color: var(--accent-blue);
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 1rem;
            font-family: 'Fira Code', monospace;
            line-height: 1.4;
            padding: 0.5rem;
        }
        
        .controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        .control-btn {
            font-family: 'Inter', sans-serif;
            font-weight: 600;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 1rem;
            box-shadow: 0 3px 10px rgba(124, 58, 237, 0.3);
            position: relative;
            overflow: hidden;
            min-height: 44px;
            min-width: 120px;
        }
        .control-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .control-btn:hover::before {
            left: 100%;
        }
        .control-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(124, 58, 237, 0.4);
        }
        .control-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .start-game-btn {
            background: linear-gradient(135deg, var(--success), var(--accent-blue));
            box-shadow: 0 3px 10px rgba(34, 197, 94, 0.3);
        }
        
        .tool-sidebar {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .restart-section {
            display: flex;
            justify-content: center;
        }
        .restart-btn {
            font-family: 'Inter', sans-serif;
            font-weight: 500;
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.6), rgba(100, 116, 139, 0.4));
            color: var(--text-secondary);
            border: 1px solid rgba(100, 116, 139, 0.5);
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            opacity: 0.6;
            backdrop-filter: blur(5px);
            min-height: 44px;
        }
        .restart-btn:hover {
            opacity: 1;
            background: linear-gradient(135deg, var(--accent-red), #dc2626);
            border-color: var(--accent-red);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
        }
        .tool-section {
            background: linear-gradient(135deg, var(--secondary-bg), var(--tertiary-bg));
            border-radius: 1rem;
            padding: 1rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        .tool-section h3 {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1rem;
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .tool-section h3::before {
            content: '';
            width: 3px;
            height: 15px;
            background: linear-gradient(180deg, var(--accent-gold), var(--accent-blue));
            border-radius: 2px;
        }
        .tool-belt {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 180px;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 0.75rem;
            border: 2px dashed var(--border-color);
        }
        .tool-slot, .potential-tool-item {
            font-family: 'Fira Code', monospace;
            font-size: 0.9rem;
            background: linear-gradient(135deg, var(--tertiary-bg), var(--secondary-bg));
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            padding: 1rem;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            line-height: 1.3;
            position: relative;
            overflow: hidden;
            word-break: break-word;
            min-width: 44px;
        }
        .tool-slot {
            cursor: pointer;
        }
        .tool-slot:hover:not(.empty-slot) {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        .tool-slot.empty-slot {
            background: linear-gradient(135deg, rgba(100, 116, 139, 0.2), rgba(100, 116, 139, 0.1));
            border-style: dashed;
            color: var(--text-muted);
            font-style: italic;
        }
        .tool-slot.empty-slot.awaiting-tool {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
            animation: pulse 1.5s infinite;
        }
        .tool-slot.drag-over-active {
            border-color: var(--accent-gold);
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(251, 191, 36, 0.1));
        }
        .potential-tools-display {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        .potential-tool-item {
            cursor: grab;
            border: 1px solid var(--accent-blue);
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.1), rgba(0, 212, 255, 0.05));
        }
        .potential-tool-item:hover {
            background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(0, 212, 255, 0.3);
        }
        .potential-tool-item:active {
            cursor: grabbing;
        }
        .potential-tool-item.selected {
            border-color: var(--accent-gold);
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(251, 191, 36, 0.15));
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.5);
            color: white;
        }
        .potential-tool-item.selected::after {
            content: '✓';
            position: absolute;
            top: 4px;
            right: 8px;
            font-size: 0.8rem;
            color: var(--accent-gold);
        }

        .mobile-tool-instructions {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-align: center;
            margin-bottom: 0.75rem;
            font-style: italic;
            display: none;
            padding: 0.5rem;
            line-height: 1.4;
        }
        .mobile-tool-instructions.managing-tools {
            color: var(--accent-gold);
            font-weight: 600;
        }
        
        .help-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            overflow-y: auto;
            padding: 1rem;
        }
        .help-modal.show {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 2rem;
        }
        .help-content {
            background: linear-gradient(135deg, var(--secondary-bg), var(--tertiary-bg));
            border-radius: 1rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }
        .help-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            position: sticky;
            top: 0;
            background: linear-gradient(135deg, var(--secondary-bg), var(--tertiary-bg));
            z-index: 1;
        }
        .help-header h2 {
            margin: 0;
            color: var(--accent-gold);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.5rem;
        }
        .close-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
            min-width: 44px;
            min-height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .close-btn:hover {
            background: var(--accent-red);
            color: white;
        }
        .help-body {
            padding: 1.5rem;
        }
        .symbol-section {
            margin-bottom: 2rem;
        }
        .symbol-section h3 {
            color: var(--accent-blue);
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.1rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--accent-blue);
            padding-bottom: 0.5rem;
        }
        .symbol-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        .symbol-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0.02));
            border-radius: 0.5rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .symbol {
            font-family: 'Fira Code', monospace;
            font-size: 1.1rem;
            color: var(--accent-gold);
            min-width: 70px;
            text-align: center;
            line-height: 1.4;
        }
        .definition {
            font-size: 0.95rem;
            color: var(--text-secondary);
            flex: 1;
            line-height: 1.4;
        }
        .definition a {
            color: var(--accent-blue);
            text-decoration: none;
            margin-left: 0.5rem;
            font-size: 0.85rem;
            display: inline-block;
            padding: 0.25rem;
        }
        .definition a:hover {
            color: var(--accent-purple);
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .game-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
                height: auto;
                min-height: 100vh;
                gap: 0.75rem;
                padding: 0.5rem;
            }
            .tool-sidebar {
                order: 2;
                max-height: none;
                overflow-y: visible;
            }
            .main-game {
                order: 1;
            }
            .restart-section {
                order: -1;
                margin-bottom: 0.75rem;
            }
            .tool-belt {
                flex-direction: row;
                flex-wrap: wrap;
                min-height: auto;
                justify-content: center;
                gap: 0.75rem;
            }
            .tool-slot {
                flex: 1;
                min-width: 120px;
                max-width: 200px;
            }
            .potential-tools-display {
                flex-direction: row;
                flex-wrap: wrap;
                justify-content: center;
                gap: 0.75rem;
            }
            .potential-tool-item {
                flex: 1;
                min-width: 120px;
                max-width: 200px;
                cursor: pointer;
            }
            .mobile-tool-instructions {
                display: block;
            }
        }
        
        @media (max-width: 768px) {
            body {
                padding: 0.25rem;
                font-size: 16px;
            }
            .game-container {
                padding: 0.25rem;
                gap: 0.5rem;
            }
            .game-area {
                padding: 1rem;
            }
            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
                grid-template-rows: repeat(3, auto);
                gap: 0.5rem;
            }
            .stat-card {
                padding: 0.75rem;
                min-height: 60px;
            }
            .stat-label {
                font-size: 0.7rem;
                margin-bottom: 0.2rem;
            }
            .stat-value {
                font-size: 1.1rem;
            }
            .game-title {
                font-size: 1.3rem;
            }
            .help-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }
            .question-text {
                font-size: 0.95rem;
                margin-bottom: 1rem;
            }
            .expressions-container {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
            .vs-text {
                order: -1;
                font-size: 1rem;
                padding: 0.5rem;
                margin-bottom: 0.5rem;
            }
            .expression-btn {
                padding: 1.25rem 1rem;
                min-height: 120px;
                font-size: 1rem;
            }
            .math-expression {
                font-size: 0.95rem;
            }
            .feedback-area {
                min-height: 70px;
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }
            .feedback-text {
                font-size: 1rem;
                margin-bottom: 0.4rem;
            }
            .correct-answer-display {
                font-size: 0.8rem;
            }
            .tool-feedback-area {
                font-size: 0.8rem;
                min-height: 35px;
                margin-bottom: 0.75rem;
            }
            .controls {
                flex-direction: column;
                align-items: center;
                gap: 0.75rem;
            }
            .control-btn {
                width: 100%;
                max-width: 280px;
                padding: 1rem;
                font-size: 0.95rem;
            }
            .tool-section {
                padding: 0.75rem;
            }
            .tool-section h3 {
                font-size: 0.9rem;
                margin-bottom: 0.5rem;
            }
            .tool-belt {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            .tool-slot, .potential-tool-item {
                font-size: 0.8rem;
                padding: 0.75rem 0.5rem;
                min-height: 48px;
                min-width: 100px;
            }
            .restart-btn {
                font-size: 0.85rem;
                padding: 0.75rem 1.25rem;
            }
            .mobile-tool-instructions {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            .help-content {
                margin: 0.5rem;
                max-height: 95vh;
            }
            .help-header {
                padding: 1rem;
            }
            .help-header h2 {
                font-size: 1.2rem;
            }
            .help-body {
                padding: 1rem;
            }
            .symbol-grid {
                grid-template-columns: 1fr;
                gap: 0.75rem;
            }
            .symbol-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            .symbol {
                min-width: auto;
                width: 100%;
                text-align: left;
                font-size: 1rem;
            }
            .definition {
                font-size: 0.9rem;
            }
        }
        
        @media (max-width: 480px) {
            .stats-bar {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: repeat(3, auto);
            }
            .stat-label {
                font-size: 0.65rem;
            }
            .stat-value {
                font-size: 1rem;
            }
            .game-title {
                font-size: 1.1rem;
            }
            .title-row {
                gap: 0.5rem;
                flex-wrap: wrap;
            }
            .help-btn {
                width: 34px;
                height: 34px;
                font-size: 0.9rem;
            }
            .question-text {
                font-size: 0.9rem;
            }
            .vs-text {
                font-size: 0.9rem;
                padding: 0.4rem;
            }
            .expression-btn {
                min-height: 100px;
                padding: 1rem 0.75rem;
                font-size: 0.9rem;
            }
            .math-expression {
                font-size: 0.85rem;
            }
            .feedback-text {
                font-size: 0.95rem;
            }
            .correct-answer-display {
                font-size: 0.75rem;
            }
            .tool-feedback-area {
                font-size: 0.75rem;
                min-height: 30px;
            }
            .control-btn {
                font-size: 0.9rem;
                padding: 0.9rem;
                max-width: 250px;
            }
            .tool-belt {
                min-height: 100px;
                gap: 0.4rem;
            }
            .tool-slot, .potential-tool-item {
                font-size: 0.75rem;
                padding: 0.6rem 0.4rem;
                min-height: 44px;
                min-width: 90px;
                flex: 1 1 calc(50% - 0.4rem);
            }
            .restart-btn {
                font-size: 0.8rem;
                padding: 0.6rem 1rem;
            }
            .mobile-tool-instructions {
                font-size: 0.7rem;
            }
            .help-header h2 {
                font-size: 1.1rem;
            }
            .close-btn {
                font-size: 1.3rem;
                min-width: 40px;
                min-height: 40px;
            }
            .symbol {
                font-size: 0.95rem;
            }
            .definition {
                font-size: 0.85rem;
            }
        }
        
        @media (max-width: 375px) {
            body {
                padding: 0.15rem;
            }
            .game-container {
                padding: 0.15rem;
            }
            .game-area {
                padding: 0.75rem;
            }
            .stats-bar {
                gap: 0.3rem;
            }
            .stat-card {
                padding: 0.5rem;
                min-height: 55px;
            }
            .tool-slot, .potential-tool-item {
                font-size: 0.7rem;
                padding: 0.5rem 0.3rem;
                min-height: 42px;
                min-width: 80px;
            }
            .expression-btn {
                min-height: 90px;
                padding: 0.75rem 0.5rem;
            }
            .control-btn {
                max-width: 220px;
                padding: 0.8rem;
            }
        }
        
        @media (max-height: 500px) and (orientation: landscape) {
            .game-container {
                grid-template-columns: 1fr 280px;
                grid-template-rows: none;
                height: 100vh;
                overflow: hidden;
            }
            .tool-sidebar {
                order: initial;
                overflow-y: auto;
            }
            .main-game {
                order: initial;
                overflow-y: auto;
            }
            .expressions-container {
                grid-template-columns: 1fr auto 1fr;
            }
            .vs-text {
                order: initial;
            }
            .stats-bar {
                grid-template-columns: repeat(5, 1fr);
                grid-template-rows: none;
            }
            .feedback-area {
                min-height: 60px;
            }
            .expression-btn {
                min-height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="background-particles" id="particles"></div>
    
    <div class="game-container">
        <div class="main-game">
            <div class="stats-bar">
                <div class="stat-card">
                    <div class="stat-label">Level</div>
                    <div class="stat-value" id="level-display">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Score</div>
                    <div class="stat-value" id="score-display">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Streak</div>
                    <div class="stat-value" id="correct-streak-display">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Lives</div>
                    <div class="stat-value" id="life-points-display">
                        <span class="hearts">❤️❤️❤️</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mode</div>
                    <div class="stat-value" id="round-mode-display">
                        <div class="round-mode">Ready</div>
                    </div>
                </div>
            </div>
            <main class="game-area">
                <div class="title-row">
                    <h1 class="game-title">∞ Math Challenge ∞</h1>
                    <button class="help-btn" id="help-btn">❓</button>
                </div>
                <p class="question-text">Which expression has the larger value?</p>
                
                <div class="expressions-container">
                    <button id="expression-a-btn" class="expression-btn"></button>
                    <div class="vs-text">VS</div>
                    <button id="expression-b-btn" class="expression-btn"></button>
                </div>
                <div class="feedback-area">
                    <div class="feedback-text" id="feedback-text">Click "Start Game" to begin!</div>
                    <div class="correct-answer-display" id="correct-answer-display"></div>
                </div>
                
                <div class="tool-feedback-area" id="tool-feedback-area"></div>
                <div class="controls">
                    <button id="next-question-btn" class="control-btn">Continue</button>
                    <button id="start-game-btn" class="control-btn start-game-btn">Start Game</button>
                </div>
            </main>
        </div>
        <div class="tool-sidebar">
            <div class="restart-section">
                <button id="restart-btn" class="restart-btn" style="display: none;">🔄 Restart Game</button>
            </div>
            
            <div class="tool-section">
                <h3>🛠️ Tool Belt</h3>
                <div class="tool-belt" id="tool-belt"></div>
            </div>
            
            <div class="tool-section">
                <h3>🎯 Available Tools</h3>
                <div class="mobile-tool-instructions">Tap tool to select → Tap slot to place/use</div>
                <div class="potential-tools-display" id="potential-tools-display"></div>
            </div>
        </div>
    </div>

    <div class="help-modal" id="help-modal">
        <div class="help-content">
            <div class="help-header">
                <h2>📚 Mathematical Symbols Guide</h2>
                <button class="close-btn" id="close-help">✕</button>
            </div>
            <div class="help-body" id="help-body-content">
                <p><i>Symbol guide will populate based on game progression.</i></p>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // DOM Elements
            const levelDisplay = document.getElementById('level-display');
            const scoreDisplay = document.getElementById('score-display');
            const correctStreakDisplay = document.getElementById('correct-streak-display');
            const lifePointsDisplay = document.getElementById('life-points-display');
            const roundModeDisplay = document.getElementById('round-mode-display');
            const expressionABtn = document.getElementById('expression-a-btn');
            const expressionBBtn = document.getElementById('expression-b-btn');
            const feedbackText = document.getElementById('feedback-text');
            const correctAnswerDisplay = document.getElementById('correct-answer-display');
            const nextQuestionBtn = document.getElementById('next-question-btn');
            const startGameBtn = document.getElementById('start-game-btn');
            const restartBtn = document.getElementById('restart-btn');
            const toolFeedbackArea = document.getElementById('tool-feedback-area');
            const toolBeltDiv = document.getElementById('tool-belt');
            const potentialToolsDisplayDiv = document.getElementById('potential-tools-display');
            const helpBtn = document.getElementById('help-btn');
            const helpModal = document.getElementById('help-modal');
            const closeHelpBtn = document.getElementById('close-help');
            const helpBodyContent = document.getElementById('help-body-content');
            const mobileToolInstructions = document.querySelector('.mobile-tool-instructions');

            // Game State
            let currentLevel = 0;
            let score = 0;
            let correctStreak = 0;
            let lifePoints = 0;
            let expressionA = { displayHTML: "", value: 0, complexity: 0, isCombinedFromTop: false };
            let expressionB = { displayHTML: "", value: 0, complexity: 0, isCombinedFromTop: false };
            let correctAnswerKey = ''; 
            let gameActive = false;
            
            const ROUND_MODES = ['Precise', 'Scale', 'Mixed'];
            let currentRoundModeIndex = 0;
            let currentRoundMode = ROUND_MODES[currentRoundModeIndex];

            const CORRECT_ANSWERS_TO_LEVEL_UP = [3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 9, 10, 12, 15, 20]; 
            const MAX_LIFE_POINTS = 3;
            const EPSILON = 1e-9; 
            
            const MAX_TOOLS = 3;
            let equippedTools = new Array(MAX_TOOLS).fill(null); 
            let potentialTools = []; 
            
            let selectedMobileTool = null; 
            let isMobileDevice = false;

            // Utility Functions
            function getRandomInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }
            function getRandomFloat(min, max, decimals = 3) { 
                const factor = Math.pow(10, decimals);
                return Math.round((Math.random() * (max - min) + min) * factor) / factor;
            }
            function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
            function formatDisplayNumber(n, precision = 3) {
                if (Number.isInteger(n)) return n.toString();
                if (Math.abs(n) < 1e-4 && n !== 0) return n.toExponential(precision-1);
                if (Math.abs(n) > 1e6) return n.toExponential(precision-1);
                return parseFloat(n.toFixed(precision)).toString();
            }
            function factorial(n) {
                if (n < 0) return NaN;
                if (n === 0) return 1;
                let result = 1;
                for (let i = 2; i <= n; i++) result *= i;
                return result;
            }
            function gamma(z) { 
                if (z < 0.5) return Math.PI / (Math.sin(Math.PI * z) * gamma(1 - z));
                z -= 1;
                let x = 0.99999999999980993;
                const p = [
                    676.5203681218851, -1259.1392167224028, 771.32342877765313,
                    -176.61502916214059, 12.507343278686905, -0.13857109526572012,
                    9.9843695780195716e-6, 1.5056327351493116e-7
                ];
                for (let i = 0; i < p.length; i++) x += p[i] / (z + i + 1);
                const t = z + p.length - 0.5;
                return Math.sqrt(2 * Math.PI) * Math.pow(t, z + 0.5) * Math.exp(-t) * x;
            }
            function zeta(s, terms = 50) { 
                if (s <= 1) return NaN; 
                let sum = 0;
                for (let n = 1; n <= terms; n++) {
                    sum += 1 / Math.pow(n, s);
                }
                return sum;
            }
            function combinations(n, k) { 
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k; 
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return res;
            }

            // Expression Generation System
            const SINGLETON_GENERATORS = {
                constant: (difficulty, targetMode) => {
                    const constants = [ 
                        { html: "π", value: Math.PI, minDiff: 0 }, 
                        { html: "e", value: Math.E, minDiff: 0 },   
                        { html: "φ", value: (1 + Math.sqrt(5)) / 2, minDiff: 0 }, 
                        { html: "γ", value: 0.5772156649, minDiff: 1 }, 
                        { html: "K", value: 0.9159655941, minDiff: 2 },  
                        { html: "ρ", value: 1.3247179572, minDiff: 2 },  
                        { html: "δ<sub>F</sub>", value: 4.6692016091, minDiff: 3 }, 
                        { html: "α<sub>F</sub>", value: 2.5029078750, minDiff: 3 }, 
                        { html: "ζ(3)", value: 1.2020569031, minDiff: 4 }, 
                    ];
                    const available = constants.filter(c => difficulty >= c.minDiff);
                    if (available.length === 0) return { html: "1", value: 1, complexity: 1};
                    const chosen = getRandomElement(available);
                    return { displayHTML: chosen.html, value: chosen.value, complexity: 1 };
                },
                integer: (difficulty, targetMode) => {
                    let val;
                    if (targetMode === 'Precise') val = getRandomInt(1, 10 + difficulty * 5);
                    else if (targetMode === 'Scale') val = getRandomInt(10, 50 + difficulty * 20);
                    else val = getRandomInt(1, 30 + difficulty * 10);
                    return { displayHTML: val.toString(), value: val, complexity: 1 };
                },
                fraction: (difficulty, targetMode) => {
                    const num = getRandomInt(1, 5 + difficulty * 2);
                    let den;
                    do { den = getRandomInt(2, 6 + difficulty * 2); } while (den === num || den === 0);
                    return { 
                        displayHTML: `<span class="math-fraction"><span class="math-numerator">${num}</span><span class="math-denominator">${den}</span></span>`,
                        value: num / den,
                        complexity: 2
                    };
                },
                power: (difficulty, targetMode) => {
                    const baseTerm = generateSingletonTerm(Math.max(0, difficulty -1), targetMode === 'Scale' ? 'Precise' : targetMode);
                    let baseVal = baseTerm.value;
                    let baseHTML = baseTerm.displayHTML;

                    if (Math.abs(baseVal) > 20 && targetMode !== 'Scale') baseVal = getRandomFloat(1.5, 5, 1);
                    if (baseVal <= 0 && difficulty < 2) baseVal = getRandomFloat(0.5, 5, 1);

                    const expType = getRandomElement([2, 3, 0.5, 1/3, -1, -2, ...(difficulty >= 1 ? [4, 1.5, 2.5, -0.5] : [])]); 
                    
                    if (baseVal < 0 && (expType !== Math.floor(expType) && expType*2 !== Math.floor(expType*2))) {
                         return generateSingletonTerm(difficulty, targetMode); 
                    }
                    
                    let val = Math.pow(baseVal, expType);
                    if (!isFinite(val) || isNaN(val) || (Math.abs(val) > 1e12 && targetMode !== 'Scale')) return generateSingletonTerm(difficulty, targetMode);

                    let displayHTML;
                    const expStr = formatDisplayNumber(expType, 2);
                    if (expType === 0.5) displayHTML = `<span class="math-sqrt-symbol">√</span><span class="math-parentheses">(</span>${baseHTML}<span class="math-parentheses">)</span>`;
                    else if (expType === 1/3) displayHTML = `<span class="math-root-index">3</span><span class="math-sqrt-symbol">√</span><span class="math-parentheses">(</span>${baseHTML}<span class="math-parentheses">)</span>`;
                    else displayHTML = `<span class="math-parentheses">(</span>${baseHTML}<span class="math-parentheses">)</span><span class="math-power">${expStr}</span>`;
                    
                    return { displayHTML, value: val, complexity: baseTerm.complexity + 2 };
                },
                logarithm: (difficulty, targetMode) => {
                    const argTerm = generateSingletonTerm(Math.max(0, difficulty -1), targetMode);
                    let argVal = argTerm.value;
                    if (argVal <= 0) return generateSingletonTerm(difficulty, targetMode);

                    const bases = [
                        { html: "e", val: Math.E, name: "ln", minDiff: 0 },
                        { val: 10, name: "log", minDiff: 0 },
                        { val: 2, name: "log", minDiff: 1 }, 
                        ...(difficulty >= 2 ? [{val: Math.PI, name:"log", minDiff:2}] : []) 
                    ];
                    const baseChoice = getRandomElement(bases.filter(b => difficulty >= b.minDiff));
                    if (!baseChoice) return { displayHTML: "ln(2)", value: Math.log(2), complexity: 2};

                    let val = Math.log(argVal) / Math.log(baseChoice.val);
                    if (!isFinite(val) || isNaN(val)) return generateSingletonTerm(difficulty, targetMode);
                    
                    let displayHTML;
                    if (baseChoice.name === "ln") displayHTML = `ln<span class="math-parentheses">(</span>${argTerm.displayHTML}<span class="math-parentheses">)</span>`;
                    else displayHTML = `log<span class="math-log-base">${baseChoice.html || baseChoice.val}</span><span class="math-parentheses">(</span>${argTerm.displayHTML}<span class="math-parentheses">)</span>`;
                    
                    return { displayHTML, value: val, complexity: argTerm.complexity + 2 };
                },
                trigonometric: (difficulty, targetMode) => {
                    const angles = [ 
                        { html: "π/6", val: Math.PI/6 }, { html: "π/4", val: Math.PI/4 }, { html: "π/3", val: Math.PI/3 },
                        { html: "π/2", val: Math.PI/2 }, { html: "2π/3", val: 2*Math.PI/3 }, { html: "3π/4", val: 3*Math.PI/4 },
                        { html: "π", val: Math.PI },
                        ...(difficulty >= 1 ? [{html: "1", val:1}, {html:"e/π", val: Math.E/Math.PI}] : []), 
                        ...(difficulty >= 2 ? [{html:"φ", val:(1+Math.sqrt(5))/2}] : []) 
                    ];
                    const angle = getRandomElement(angles);
                    const funcs = ['sin', 'cos', 'tan'];
                    if (difficulty >= 1) funcs.push('csc', 'sec', 'cot'); 
                    const funcName = getRandomElement(funcs);
                    
                    let val;
                    switch(funcName) {
                        case 'sin': val = Math.sin(angle.val); break;
                        case 'cos': val = Math.cos(angle.val); break;
                        case 'tan': val = Math.tan(angle.val); break;
                        case 'csc': val = 1 / Math.sin(angle.val); break;
                        case 'sec': val = 1 / Math.cos(angle.val); break;
                        case 'cot': val = 1 / Math.tan(angle.val); break;
                    }

                    if (!isFinite(val) || isNaN(val) || (Math.abs(val) > 100 && targetMode !== 'Scale')) {
                        return generateSingletonTerm(difficulty, targetMode);
                    }
                    return { 
                        displayHTML: `${funcName}<span class="math-parentheses">(</span>${angle.html}<span class="math-parentheses">)</span>`, 
                        value: val, 
                        complexity: 3 
                    };
                },
                factorial: (difficulty, targetMode) => {
                    const n = getRandomInt(3, 5 + Math.min(difficulty, 3)); 
                    const val = factorial(n);
                    if (!isFinite(val) || (Math.abs(val) > 1e6 && targetMode !== 'Scale')) return generateSingletonTerm(difficulty, targetMode);
                    return { displayHTML: `${n}!`, value: val, complexity: 2 };
                },
                specialFunction: (difficulty, targetMode) => { 
                    const functions = [];
                    if (difficulty >= 1) { 
                        const n_gamma = getRandomElement([0.5, 1.5, 2, 2.5, 3, 3.5, 4]);
                        functions.push({
                            displayHTML: `Γ<span class="math-parentheses">(</span>${n_gamma}<span class="math-parentheses">)</span>`,
                            value: gamma(n_gamma),
                            complexity: 4
                        });
                    }
                    if (difficulty >= 2) { 
                        const s_zeta = getRandomElement([2,3,4]); 
                        let html_zeta = `ζ<span class="math-parentheses">(</span>${s_zeta}<span class="math-parentheses">)</span>`;
                        let val_zeta = zeta(s_zeta);
                        if (s_zeta === 2) { html_zeta = `π<span class="math-power">2</span>/6`; val_zeta = Math.pow(Math.PI,2)/6;}
                        functions.push({ displayHTML: html_zeta, value: val_zeta, complexity: 5 });
                    }
                     if (difficulty >= 2) { 
                        const n_binom = getRandomInt(4, 7 + difficulty); 
                        const k_binom = getRandomInt(2, Math.min(n_binom -1, 4)); 
                        functions.push({
                            displayHTML: `C<span class="math-parentheses">(</span>${n_binom},${k_binom}<span class="math-parentheses">)</span>`,
                            value: combinations(n_binom, k_binom),
                            complexity: 4
                        });
                    }

                    if (functions.length === 0) return SINGLETON_GENERATORS.constant(difficulty,targetMode);
                    const chosen = getRandomElement(functions);
                    if (!isFinite(chosen.value) || isNaN(chosen.value)) return SINGLETON_GENERATORS.constant(difficulty,targetMode);
                    return chosen;
                }
            };

            function generateSingletonTerm(difficulty, targetMode) {
                const baseTypes = ['integer', 'constant', 'fraction', 'power'];
                const midTypes = ['logarithm', 'trigonometric', 'factorial'];
                const advancedType = 'specialFunction';

                let availableTypes = [...baseTypes];
                if (difficulty >= 1 && Math.random() < 0.3 + difficulty * 0.1) { 
                    availableTypes.push(...midTypes);
                }
                
                if (difficulty >= 2 && Math.random() < 0.25 + difficulty * 0.12) { 
                    availableTypes.push(advancedType);
                } else if (difficulty >=1 && Math.random() < 0.2 + difficulty * 0.08) { 
                     availableTypes.push(advancedType);
                }

                const type = getRandomElement(availableTypes);
                try {
                    const term = SINGLETON_GENERATORS[type](difficulty, targetMode);
                    if (term && typeof term.value === 'number' && isFinite(term.value) && term.displayHTML) {
                        return term; 
                    }
                    throw new Error("Invalid term generated in generateSingletonTerm (after check)");
                } catch (e) {
                    console.warn(`Generator error for type ${type}, difficulty ${difficulty}: ${e.message}. Falling back.`);
                    return { displayHTML: "1", value: 1, complexity: 1}; 
                }
            }

            function combineTerms(termA, termB, difficulty) {
                const operators = [
                    { op: '+', html: "+", complexityEffect: 1 }, 
                    { op: '-', html: "-", complexityEffect: 1 },
                    { op: '*', html: "×", complexityEffect: 2 },
                    { op: '/', html: "/", complexityEffect: 2 }
                ];
                const chosenOp = getRandomElement(operators);
                
                let value;
                switch (chosenOp.op) {
                    case '+': value = termA.value + termB.value; break;
                    case '-': value = termA.value - termB.value; break;
                    case '*': value = termA.value * termB.value; break;
                    case '/': 
                        if (Math.abs(termB.value) < EPSILON) return null; 
                        value = termA.value / termB.value; 
                        break;
                    default: return null;
                }

                if (!isFinite(value) || isNaN(value)) return null;

                const displayHTML = `<span class="math-parentheses">(</span>${termA.displayHTML}${chosenOp.html}${termB.displayHTML}<span class="math-parentheses">)</span>`;
                
                return {
                    displayHTML: displayHTML, 
                    value: value,
                    complexity: termA.complexity + termB.complexity + chosenOp.complexityEffect,
                    isCombined: true 
                };
            }

            function generateComplexExpression(difficulty, targetMode, depth = 0) {
                let term;
                const maxDepth = Math.min(1 + Math.floor(difficulty / 3), 2);
                
                if (depth >= maxDepth || Math.random() < 0.55 - difficulty * 0.05) {
                    term = generateSingletonTerm(difficulty, targetMode);
                    term.isCombinedFromTop = false; 
                } else {
                    const termA = generateComplexExpression(difficulty, targetMode, depth + 1, maxDepth);
                    const termB = generateComplexExpression(difficulty, targetMode, depth + 1, maxDepth);

                    if (!termA || !termB) {
                        term = generateSingletonTerm(difficulty, targetMode);
                        term.isCombinedFromTop = false;
                    } else {
                        term = combineTerms(termA, termB, difficulty);
                        if (!term) {
                             term = generateSingletonTerm(difficulty, targetMode);
                             term.isCombinedFromTop = false;
                        } else {
                            term.isCombinedFromTop = (depth === 0); 
                        }
                    }
                }
                return term;
            }
            
            function generateQuestionPair(level) {
                const difficulty = Math.floor(level / 2); 
                let termA, termB;
                let attempts = 0;
                const MAX_ATTEMPTS_PAIR = 30;

                do {
                    attempts++;
                    termA = generateComplexExpression(difficulty, currentRoundMode);
                    termB = generateComplexExpression(difficulty, currentRoundMode);

                    if (attempts > MAX_ATTEMPTS_PAIR) { 
                        console.warn("Max attempts for pair, simpler terms.");
                        termA = generateSingletonTerm(Math.max(0, difficulty-1), currentRoundMode);
                        termB = generateSingletonTerm(Math.max(0, difficulty-1), currentRoundMode);
                        termA.isCombinedFromTop = false; 
                        termB.isCombinedFromTop = false;
                    }
                     if (!termA || !termB || typeof termA.value !== 'number' || typeof termB.value !== 'number' ||
                        !isFinite(termA.value) || !isFinite(termB.value) || isNaN(termA.value) || isNaN(termB.value)) {
                        termA = null; 
                        continue;
                    }

                } while (!termA || !termB || Math.abs(termA.value - termB.value) < EPSILON * Math.max(1, Math.abs(termA.value), Math.abs(termB.value)));
                
                if (Math.random() < 0.5) {
                    return { expr1: termA, expr2: termB };
                } else {
                    return { expr1: termB, expr2: termA };
                }
            }

            function performCherryPicking(level) {
                const numCandidates = 35 + level * 4;
                let candidates = [];

                for (let i = 0; i < numCandidates; i++) {
                    const pair = generateQuestionPair(level);
                    if (pair && pair.expr1 && pair.expr2 && 
                        typeof pair.expr1.value === 'number' && typeof pair.expr2.value === 'number' &&
                        isFinite(pair.expr1.value) && isFinite(pair.expr2.value)) { 
                        
                        const valA = pair.expr1.value;
                        const valB = pair.expr2.value;
                        
                        if ((valA * valB < 0) && (Math.abs(valA) > EPSILON*10 && Math.abs(valB) > EPSILON*10) ) {
                            continue; 
                        }

                        const minAbsVal = Math.min(Math.abs(valA), Math.abs(valB));
                        const maxAbsVal = Math.max(Math.abs(valA), Math.abs(valB));
                        if (minAbsVal < EPSILON) {
                            if (maxAbsVal > 1) continue;
                        } else {
                            const ratio = maxAbsVal / minAbsVal;
                            const maxAllowedRatio = 10 - level * 0.3;
                            if (ratio > Math.max(2.5, maxAllowedRatio)) {
                                continue;
                            }
                        }
                        
                        if (Math.abs(valA - valB) < EPSILON * Math.max(1, Math.abs(valA), Math.abs(valB))) {
                            continue;
                        }

                        const diff = Math.abs(valA - valB);
                        const magnitude = Math.max(Math.abs(valA), Math.abs(valB), 0.1);
                        const relativeDifference = diff / magnitude; 
                        const complexityScoreValue = (pair.expr1.complexity + pair.expr2.complexity);

                        let challengeScore = 0;
                        const idealRelativeDiffMin = 0.005;
                        const idealRelativeDiffMax = 0.10;
                        const veryClosePenaltyThreshold = 0.0005;

                        if (relativeDifference < veryClosePenaltyThreshold) {
                            challengeScore -= 10000;
                        } else if (relativeDifference >= idealRelativeDiffMin && relativeDifference <= idealRelativeDiffMax) {
                            challengeScore += 500;
                            challengeScore += (1 - (relativeDifference - idealRelativeDiffMin) / (idealRelativeDiffMax - idealRelativeDiffMin)) * 250; 
                        } else if (relativeDifference < idealRelativeDiffMin) { 
                            challengeScore += 100 - (idealRelativeDiffMin - relativeDifference) * 2000; 
                        } else {
                            challengeScore -= (relativeDifference - idealRelativeDiffMax) * 200; 
                        }
                        
                        challengeScore += complexityScoreValue * 1.5;

                        candidates.push({ ...pair, challengeScore });
                    }
                }

                if (candidates.length === 0) { 
                    console.warn("Cherry picking fallback after filtering.");
                    const fallbackPair = generateQuestionPair(Math.max(0, level -1)); 
                     if (!fallbackPair || !fallbackPair.expr1 || !fallbackPair.expr2 || 
                         typeof fallbackPair.expr1.value !== 'number' || typeof fallbackPair.expr2.value !== 'number' ||
                         !isFinite(fallbackPair.expr1.value) || !isFinite(fallbackPair.expr2.value) ) { 
                        return {
                            expr1: { displayHTML: "2", value: 2, complexity: 1, isCombinedFromTop: false }, 
                            expr2: { displayHTML: "1", value: 1, complexity: 1, isCombinedFromTop: false }  
                        };
                    }
                    return fallbackPair;
                }

                candidates.sort((a, b) => b.challengeScore - a.challengeScore); 

                const topPercent = Math.max(0.05, 0.4 - level * 0.02);
                const selectionPoolSize = Math.max(1, Math.floor(candidates.length * topPercent));
                
                return candidates[getRandomInt(0, selectionPoolSize - 1)];
            }

            // Tool System
            function renderToolSlots() {
                toolBeltDiv.innerHTML = '';
                for (let i = 0; i < MAX_TOOLS; i++) {
                    const toolSlot = document.createElement('div');
                    toolSlot.classList.add('tool-slot');
                    toolSlot.dataset.slotIndex = i;

                    if (equippedTools[i]) {
                        toolSlot.innerHTML = equippedTools[i].displayHTML; 
                        toolSlot.addEventListener('click', () => {
                             if (isMobileDevice) {
                                if (selectedMobileTool) { 
                                    handleMobileSlotSelection(i);
                                } else { 
                                    useTool(i);
                                }
                            } else { 
                                useTool(i);
                            }
                        });
                    } else {
                        toolSlot.innerHTML = `Slot ${i + 1}`;
                        toolSlot.classList.add('empty-slot');
                         if (isMobileDevice) {
                            toolSlot.addEventListener('click', () => handleMobileSlotSelection(i));
                        }
                    }
                    
                    if (!isMobileDevice) { 
                        toolSlot.addEventListener('dragover', (e) => { e.preventDefault(); toolSlot.classList.add('drag-over-active'); });
                        toolSlot.addEventListener('dragleave', () => toolSlot.classList.remove('drag-over-active'));
                        toolSlot.addEventListener('drop', (e) => {
                            e.preventDefault();
                            toolSlot.classList.remove('drag-over-active');
                            try {
                                const draggedToolData = JSON.parse(e.dataTransfer.getData("application/json"));
                                if (draggedToolData && typeof draggedToolData.tool !== 'undefined') {
                                    equipTool(draggedToolData.tool, i); 
                                    if (typeof draggedToolData.originalIndex === 'number') {
                                        potentialTools.splice(draggedToolData.originalIndex, 1);
                                        renderPotentialTools();
                                    }
                                }
                            } catch (error) { console.error("Error parsing dropped tool data:", error); }
                        });
                    }
                    toolBeltDiv.appendChild(toolSlot);
                }
                 updateMobileInstructions(); 
            }

            function renderPotentialTools() {
                potentialToolsDisplayDiv.innerHTML = '';
                if (!gameActive && score === 0 && currentLevel === 0) {
                    potentialToolsDisplayDiv.innerHTML = '<p style="font-size:0.8rem; color:var(--text-muted); font-style:italic; padding:1rem; text-align:center;">Tools appear after answering.</p>';
                    return;
                }
                if (potentialTools.length === 0) {
                     potentialToolsDisplayDiv.innerHTML = gameActive ? 
                        '<p style="font-size:0.8rem; color:var(--text-muted); font-style:italic; padding:1rem; text-align:center;">Answer to unlock tools.</p>' :
                        '<p style="font-size:0.8rem; color:var(--text-muted); font-style:italic; padding:1rem; text-align:center;">Game Over</p>';
                    return;
                }

                potentialTools.forEach((tool, index) => {
                    const toolItem = document.createElement('div');
                    toolItem.classList.add('potential-tool-item');
                    toolItem.innerHTML = tool.displayHTML; 
                    
                    if (isMobileDevice) {
                        toolItem.addEventListener('click', () => handleMobileToolSelection(tool, index, toolItem));
                    } else { 
                        toolItem.draggable = true;
                        toolItem.addEventListener('dragstart', (e) => {
                            try {
                                const toolJson = JSON.stringify({ tool: tool, originalIndex: index }); 
                                e.dataTransfer.setData("application/json", toolJson);
                                e.dataTransfer.effectAllowed = "move";
                            } catch (error) { console.error("Error stringifying tool data for drag:", error); }
                        });
                    }
                    potentialToolsDisplayDiv.appendChild(toolItem);
                });
                 updateMobileInstructions();
            }

            function equipTool(toolData, slotIndex) { 
                if (slotIndex >= 0 && slotIndex < MAX_TOOLS) {
                    equippedTools[slotIndex] = { ...toolData }; 
                }
                renderToolSlots();
            }
            
            function useTool(toolIndex) { 
                if (!equippedTools[toolIndex] || !gameActive || expressionABtn.disabled) return; 
                
                const tool = equippedTools[toolIndex];
                expressionABtn.classList.remove('tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');
                expressionBBtn.classList.remove('tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');

                let hintClassA = "", hintClassB = "";
                let feedbackTextA = "", feedbackTextB = "";

                if (Math.abs(tool.value - expressionA.value) < EPSILON * Math.max(1, Math.abs(tool.value), Math.abs(expressionA.value))) {
                    hintClassA = 'tool-hint-equal'; feedbackTextA = "A ≈ Tool";
                } else if (tool.value > expressionA.value) {
                    hintClassA = 'tool-hint-smaller'; feedbackTextA = "A < Tool";
                } else {
                    hintClassA = 'tool-hint-larger'; feedbackTextA = "A > Tool";
                }

                if (Math.abs(tool.value - expressionB.value) < EPSILON * Math.max(1, Math.abs(tool.value), Math.abs(expressionB.value))) {
                    hintClassB = 'tool-hint-equal'; feedbackTextB = "B ≈ Tool";
                } else if (tool.value > expressionB.value) {
                    hintClassB = 'tool-hint-smaller'; feedbackTextB = "B < Tool";
                } else {
                    hintClassB = 'tool-hint-larger'; feedbackTextB = "B > Tool";
                }

                expressionABtn.classList.add(hintClassA);
                expressionBBtn.classList.add(hintClassB);
                toolFeedbackArea.innerHTML = `🔍 ${feedbackTextA}, ${feedbackTextB} (Tool: ${formatDisplayNumber(tool.value, 4)})`;
                
                setTimeout(() => {
                    if (gameActive) { 
                         expressionABtn.classList.remove('tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');
                         expressionBBtn.classList.remove('tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');
                         if (toolFeedbackArea.innerHTML.startsWith("🔍")) toolFeedbackArea.innerHTML = ""; 
                    }
                }, 3500);
            }

            // Mobile Tool Interaction
            function updateMobileInstructions() {
                if (!isMobileDevice || !mobileToolInstructions) return;
                mobileToolInstructions.style.display = 'block'; 
                if (selectedMobileTool) {
                    mobileToolInstructions.textContent = "Tap an empty slot to place, or an equipped tool to replace/use.";
                    mobileToolInstructions.classList.add('managing-tools');
                } else {
                    mobileToolInstructions.textContent = "Tap tool in 'Available' to select, then tap slot in 'Belt'. Tap equipped tool to use.";
                    mobileToolInstructions.classList.remove('managing-tools');
                }
            }

            function handleMobileToolSelection(toolData, originalIndex, toolItemElement) { 
                if (selectedMobileTool && selectedMobileTool.toolData.displayHTML === toolData.displayHTML && selectedMobileTool.toolData.value === toolData.value) {
                    selectedMobileTool = null;
                    toolItemElement.classList.remove('selected');
                    clearAwaitingSlots();
                } else {
                    if (selectedMobileTool && selectedMobileTool.element) {
                        selectedMobileTool.element.classList.remove('selected');
                    }
                    selectedMobileTool = { toolData: toolData, originalIndexInPotential: originalIndex, element: toolItemElement };
                    toolItemElement.classList.add('selected');
                    highlightEmptySlotsForMobile();
                }
                updateMobileInstructions();
            }

            function handleMobileSlotSelection(slotIndex) {
                if (selectedMobileTool) { 
                    equipTool(selectedMobileTool.toolData, slotIndex); 
                    potentialTools.splice(selectedMobileTool.originalIndexInPotential, 1);
                    renderPotentialTools(); 
                    
                    selectedMobileTool = null; 
                    clearAwaitingSlots();
                } else { 
                    useTool(slotIndex);
                }
                updateMobileInstructions();
            }
            
            function highlightEmptySlotsForMobile() {
                document.querySelectorAll('.tool-slot.empty-slot').forEach(slot => slot.classList.add('awaiting-tool'));
            }
            function clearAwaitingSlots() {
                document.querySelectorAll('.tool-slot.awaiting-tool').forEach(slot => slot.classList.remove('awaiting-tool'));
                if(selectedMobileTool && selectedMobileTool.element) selectedMobileTool.element.classList.remove('selected');
            }

            // Game Flow & UI Updates
            function updateStats() {
                let difficultyIcon = "";
                if (currentLevel >= 12) difficultyIcon = " 🌌"; 
                else if (currentLevel >= 9) difficultyIcon = " 🌟"; 
                else if (currentLevel >= 6) difficultyIcon = " 🎓"; 
                else if (currentLevel >= 3) difficultyIcon = " 🔥"; 
                levelDisplay.textContent = currentLevel + difficultyIcon;
                scoreDisplay.textContent = score;
                correctStreakDisplay.textContent = correctStreak;
                
                const modeName = ROUND_MODES[currentRoundModeIndex];
                roundModeDisplay.innerHTML = `<div class="round-mode">${modeName}</div>`;

                let heartsHTML = '';
                for (let i = 0; i < MAX_LIFE_POINTS; i++) {
                    const heartIcon = i < lifePoints ? '❤️' : '🖤'; 
                    heartsHTML += `<span class="heart">${heartIcon}</span>`;
                }
                lifePointsDisplay.innerHTML = `<span class="hearts">${heartsHTML}</span>`;
            }

            function animateHeartRefill() {
                updateStats(); 
                setTimeout(() => {
                    const heartSpans = lifePointsDisplay.querySelectorAll('.heart');
                    if (heartSpans[lifePoints - 1]) { 
                        heartSpans[lifePoints - 1].classList.add('pop');
                    }
                }, 50); 
            }
            function animateAllHearts() {
                updateStats();
                setTimeout(() => {
                    const heartSpans = lifePointsDisplay.querySelectorAll('.heart');
                    heartSpans.forEach((heart, index) => {
                        if (index < lifePoints) { 
                           setTimeout(() => heart.classList.add('pop'), index * 150);
                        }
                    });
                }, 50);
            }

            function displayCurrentQuestion() {
                expressionABtn.innerHTML = expressionA.displayHTML;
                expressionBBtn.innerHTML = expressionB.displayHTML;
                feedbackText.textContent = "";
                correctAnswerDisplay.textContent = "";
                feedbackText.className = 'feedback-text';
                expressionABtn.disabled = false;
                expressionBBtn.disabled = false;
                expressionABtn.classList.remove('disabled', 'tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');
                expressionBBtn.classList.remove('disabled', 'tool-hint-larger', 'tool-hint-smaller', 'tool-hint-equal');
                
                toolFeedbackArea.innerHTML = "";
                nextQuestionBtn.style.display = 'none';
                nextQuestionBtn.disabled = true;

                if (gameActive) {
                    startGameBtn.style.display = 'none';
                    restartBtn.style.display = 'inline-block';
                } else { 
                    startGameBtn.style.display = 'inline-block';
                    startGameBtn.disabled = false; 
                    restartBtn.style.display = 'none';
                }
                if (selectedMobileTool && selectedMobileTool.element) selectedMobileTool.element.classList.remove('selected');
                selectedMobileTool = null;
                clearAwaitingSlots();
                updateMobileInstructions();
            }

            function handleAnswer(chosenButtonKey) {
                if (!gameActive) return;
                expressionABtn.disabled = true;
                expressionBBtn.disabled = true;
                expressionABtn.classList.add('disabled');
                expressionBBtn.classList.add('disabled');

                potentialTools = [
                    { displayHTML: expressionA.displayHTML, value: expressionA.value, complexity: expressionA.complexity },
                    { displayHTML: expressionB.displayHTML, value: expressionB.value, complexity: expressionB.complexity }
                ];
                potentialTools.sort((a,b) => b.complexity - a.complexity || b.value - a.value);
                renderPotentialTools();

                if (chosenButtonKey === correctAnswerKey) {
                    feedbackText.textContent = "🎉 Correct!";
                    feedbackText.className = 'feedback-text correct';
                    score++;
                    correctStreak++;
                    
                    let autoAdvanceDelay = 1200;
                    const requiredForLevelUp = CORRECT_ANSWERS_TO_LEVEL_UP[Math.min(currentLevel, CORRECT_ANSWERS_TO_LEVEL_UP.length - 1)];
                    
                    if (correctStreak >= requiredForLevelUp && currentLevel < 15) { 
                        currentLevel++;
                        correctStreak = 0;
                        currentRoundModeIndex = (currentRoundModeIndex + 1) % ROUND_MODES.length; 
                        currentRoundMode = ROUND_MODES[currentRoundModeIndex];

                        if (lifePoints < MAX_LIFE_POINTS) {
                            lifePoints++;
                            animateHeartRefill(); 
                        }
                        feedbackText.textContent += ` Level ${currentLevel}! Mode: ${currentRoundMode}.`;
                        autoAdvanceDelay = 2000;
                        populateHelpModalContent(); 
                    }
                    updateStats();
                    setTimeout(() => {
                        if (gameActive && lifePoints > 0) { 
                            feedbackText.textContent = autoAdvanceDelay > 1500 ? "🌟 Level Up! Next..." : "🚀 Next Question...";
                            setTimeout(prepareNextQuestion, 400);
                        }
                    }, autoAdvanceDelay);

                } else { 
                    feedbackText.textContent = "❌ Incorrect";
                    feedbackText.className = 'feedback-text incorrect';
                    correctStreak = 0;
                    lifePoints--;
                    
                    const actualLargerDisplay = correctAnswerKey === 'A' ? expressionA.displayHTML : expressionB.displayHTML;
                    const actualSmallerDisplay = correctAnswerKey === 'A' ? expressionB.displayHTML : expressionA.displayHTML;
                    const valLarger = correctAnswerKey === 'A' ? expressionA.value : expressionB.value;
                    const valSmaller = correctAnswerKey === 'A' ? expressionB.value : expressionA.value;
                    correctAnswerDisplay.innerHTML = `Correct: ${actualLargerDisplay} (${formatDisplayNumber(valLarger,4)}) > ${actualSmallerDisplay} (${formatDisplayNumber(valSmaller,4)})`;
                    
                    updateStats(); 
                    if (lifePoints <= 0) {
                        console.log(`MathChallenge: Game Over triggered from incorrect answer. Score: ${score}, Level: ${currentLevel}`);
                        setTimeout(gameOver, 1200);
                    } else {
                        console.log(`MathChallenge: Incorrect. Lives left: ${lifePoints}. Showing Continue button.`);
                        nextQuestionBtn.disabled = false;
                        nextQuestionBtn.style.display = 'inline-block'; 
                    }
                }
            }

            function prepareNextQuestion() {
                if (!gameActive || lifePoints <= 0) {
                    if (lifePoints <= 0 && gameActive) gameOver();
                    return;
                }
                
                const questionData = performCherryPicking(currentLevel);
                let expr1RawHTML, expr2RawHTML;

                if (!questionData || !questionData.expr1 || !questionData.expr2 || 
                    typeof questionData.expr1.value !== 'number' || typeof questionData.expr2.value !== 'number' ||
                    !isFinite(questionData.expr1.value) || !isFinite(questionData.expr2.value)) {
                    console.error("Invalid question data from cherry picking:", questionData);
                    expressionA = { displayHTML: "<span class=\"math-expression\">3</span>", value: 3, complexity: 1, isCombinedFromTop: false };
                    expressionB = { displayHTML: "<span class=\"math-expression\">2</span>", value: 2, complexity: 1, isCombinedFromTop: false };
                } else {
                    expr1RawHTML = questionData.expr1.displayHTML;
                    if (questionData.expr1.isCombinedFromTop) { 
                        const openingTag = '<span class="math-parentheses">(</span>';
                        const closingTag = '<span class="math-parentheses">)</span>';
                        if (expr1RawHTML.startsWith(openingTag) && expr1RawHTML.endsWith(closingTag) && expr1RawHTML.length > openingTag.length + closingTag.length) {
                            let balance = 0;
                            let canStrip = true;
                            for(let k=openingTag.length; k < expr1RawHTML.length - closingTag.length; k++) {
                                if (expr1RawHTML.substring(k).startsWith(openingTag)) balance++;
                                else if (expr1RawHTML.substring(k).startsWith(closingTag)) balance--;
                                if (balance < 0) { 
                                    canStrip = false;
                                    break;
                                }
                            }
                            if (canStrip && balance === 0) { 
                                expr1RawHTML = expr1RawHTML.substring(openingTag.length, expr1RawHTML.length - closingTag.length);
                            }
                        }
                    }
                    expressionA = {
                        ...questionData.expr1,
                        displayHTML: `<span class="math-expression">${expr1RawHTML}</span>`
                    };

                    expr2RawHTML = questionData.expr2.displayHTML;
                    if (questionData.expr2.isCombinedFromTop) {
                        const openingTag = '<span class="math-parentheses">(</span>';
                        const closingTag = '<span class="math-parentheses">)</span>';
                        if (expr2RawHTML.startsWith(openingTag) && expr2RawHTML.endsWith(closingTag) && expr2RawHTML.length > openingTag.length + closingTag.length) {
                            let balance = 0;
                            let canStrip = true;
                             for(let k=openingTag.length; k < expr2RawHTML.length - closingTag.length; k++) {
                                if (expr2RawHTML.substring(k).startsWith(openingTag)) balance++;
                                else if (expr2RawHTML.substring(k).startsWith(closingTag)) balance--;
                                if (balance < 0) {canStrip = false; break; }
                            }
                            if (canStrip && balance === 0) {
                                expr2RawHTML = expr2RawHTML.substring(openingTag.length, expr2RawHTML.length - closingTag.length);
                            }
                        }
                    }
                    expressionB = {
                        ...questionData.expr2,
                        displayHTML: `<span class="math-expression">${expr2RawHTML}</span>`
                    };
                }
                correctAnswerKey = (expressionA.value > expressionB.value) ? 'A' : 'B';
                displayCurrentQuestion();
            }

            function startGame() {
                currentLevel = 0;
                score = 0;
                correctStreak = 0;
                lifePoints = MAX_LIFE_POINTS;
                gameActive = true;
                equippedTools.fill(null);
                potentialTools = [];
                selectedMobileTool = null;
                currentRoundModeIndex = 0;
                currentRoundMode = ROUND_MODES[currentRoundModeIndex];
                
                renderToolSlots();
                renderPotentialTools();
                updateStats(); 
                animateAllHearts(); 
                
                feedbackText.className = 'feedback-text';
                toolFeedbackArea.innerHTML = "";
                startGameBtn.textContent = "Start Game"; 

                populateHelpModalContent(); 
                prepareNextQuestion();
            }

            function gameOver() {
                gameActive = false;
                feedbackText.textContent = "🎮 GAME OVER!";
                feedbackText.className = 'feedback-text game-over';
                correctAnswerDisplay.textContent = `Final Score: ${score} at Level ${currentLevel}`;
                
                expressionABtn.disabled = true;
                expressionBBtn.disabled = true;
                nextQuestionBtn.style.display = 'none';
                nextQuestionBtn.disabled = true;
                
                startGameBtn.style.display = 'inline-block';
                startGameBtn.disabled = false;
                startGameBtn.textContent = "Play Again";
                restartBtn.style.display = 'none';

                potentialToolsDisplayDiv.innerHTML = '<p style="font-size:0.8rem; color:var(--text-muted); font-style:italic; padding:1rem; text-align:center;">Game Over</p>';
                roundModeDisplay.innerHTML = `<div class="round-mode">Ready</div>`;
                if (selectedMobileTool && selectedMobileTool.element) selectedMobileTool.element.classList.remove('selected');
                selectedMobileTool = null;
                clearAwaitingSlots();
                updateMobileInstructions();
            }

            // Help Modal Content
            const symbolGuide = [ 
                { level: 0, symbol: "π", definition: "Pi (≈ 3.14159)", link: "https://en.wikipedia.org/wiki/Pi" },
                { level: 0, symbol: "e", definition: "Euler's number (≈ 2.71828)", link: "https://en.wikipedia.org/wiki/E_(mathematical_constant)" },
                { level: 0, symbol: "n!", definition: "Factorial (n × (n-1) × ... × 1)", link: "https://en.wikipedia.org/wiki/Factorial" },
                { level: 0, symbol: "√x", definition: "Square root", link: "https://en.wikipedia.org/wiki/Square_root" },
                { level: 0, symbol: "x<span class='math-power'>y</span>", definition: "Exponentiation (x to the power of y)", link: "https://en.wikipedia.org/wiki/Exponentiation" },
                { level: 1, symbol: "φ", definition: "Golden ratio (≈ 1.618)", link: "https://en.wikipedia.org/wiki/Golden_ratio" },
                { level: 1, symbol: "ln(x)", definition: "Natural logarithm (log base e)", link: "https://en.wikipedia.org/wiki/Natural_logarithm" },
                { level: 1, symbol: "log<sub class='math-log-base'>b</sub>(x)", definition: "Logarithm base b", link: "https://en.wikipedia.org/wiki/Logarithm" },
                { level: 2, symbol: "γ", definition: "Euler-Mascheroni constant (≈ 0.577)", link: "https://en.wikipedia.org/wiki/Euler%E2%80%93Mascheroni_constant" },
                { level: 2, symbol: "sin(x), cos(x), tan(x)", definition: "Trigonometric functions", link: "https://en.wikipedia.org/wiki/Trigonometric_functions" },
                { level: 3, symbol: "csc(x), sec(x), cot(x)", definition: "Reciprocal trigonometric functions", link: "https://en.wikipedia.org/wiki/Trigonometric_functions" },
                { level: 3, symbol: "Γ(z)", definition: "Gamma function (extension of factorial)", link: "https://en.wikipedia.org/wiki/Gamma_function" },
                { level: 4, symbol: "K", definition: "Catalan's constant (≈ 0.916)", link: "https://en.wikipedia.org/wiki/Catalan%27s_constant" },
                { level: 4, symbol: "ρ", definition: "Plastic number (≈ 1.325)", link: "https://en.wikipedia.org/wiki/Plastic_number" },
                { level: 4, symbol: "C(n,k)", definition: "Binomial coefficient ('n choose k')", link: "https://en.wikipedia.org/wiki/Binomial_coefficient"},
                { level: 5, symbol: "ζ(s)", definition: "Riemann Zeta function", link: "https://en.wikipedia.org/wiki/Riemann_zeta_function" },
                { level: 6, symbol: "δ<sub>F</sub>, α<sub>F</sub>", definition: "Feigenbaum constants (chaos theory)", link: "https://en.wikipedia.org/wiki/Feigenbaum_constants" },
                { level: 7, symbol: "ζ(3)", definition: "Apéry's constant (≈ 1.202)", link: "https://en.wikipedia.org/wiki/Ap%C3%A9ry%27s_constant" },
            ];

            function populateHelpModalContent() {
                helpBodyContent.innerHTML = '';
                const maxLevelReached = currentLevel; 
                const sections = [
                    { title: "Basics (Level 0-1)", min: 0, max: 1 },
                    { title: "Intermediate (Level 2-3)", min: 2, max: 3 },
                    { title: "Advanced (Level 4-5)", min: 4, max: 5 },
                    { title: "Expert (Level 6+)", min: 6, max: 15 } 
                ];

                sections.forEach(section => {
                    const relevantSymbols = symbolGuide.filter(s => s.level >= section.min && s.level <= section.max && s.level <= maxLevelReached +1); 
                    if (relevantSymbols.length > 0) {
                        const sectionDiv = document.createElement('div');
                        sectionDiv.className = 'symbol-section';
                        const titleH3 = document.createElement('h3');
                        titleH3.textContent = section.title;
                        sectionDiv.appendChild(titleH3);

                        const gridDiv = document.createElement('div');
                        gridDiv.className = 'symbol-grid';
                        relevantSymbols.forEach(s => {
                            const itemDiv = document.createElement('div');
                            itemDiv.className = 'symbol-item';
                            const symbolSpan = document.createElement('span');
                            symbolSpan.className = 'symbol math-expression'; 
                            symbolSpan.innerHTML = s.symbol; 
                            const defSpan = document.createElement('span');
                            defSpan.className = 'definition';
                            defSpan.innerHTML = `${s.definition} <a href="${s.link}" target="_blank" rel="noopener noreferrer">📖</a>`;
                            itemDiv.appendChild(symbolSpan);
                            itemDiv.appendChild(defSpan);
                            gridDiv.appendChild(itemDiv);
                        });
                        sectionDiv.appendChild(gridDiv);
                        helpBodyContent.appendChild(sectionDiv);
                    }
                });
                 if (helpBodyContent.children.length === 0) {
                    helpBodyContent.innerHTML = "<p>Symbols will appear here as you progress!</p>";
                }
            }

            // Initial Setup & Event Listeners
            function init() {
                const particleContainer = document.getElementById('particles');
                if (particleContainer) { 
                    for (let i = 0; i < 30; i++) {
                        const particle = document.createElement('div');
                        particle.className = 'particle';
                        particle.style.left = Math.random() * 100 + '%';
                        particle.style.top = Math.random() * 100 + '%';
                        particle.style.animationDelay = Math.random() * 6 + 's';
                        particle.style.animationDuration = (Math.random() * 3 + 3) + 's';
                        particleContainer.appendChild(particle);
                    }
                } else {
                    console.warn("Particle container not found.");
                }
                
                function updateMobileStatus() {
                    isMobileDevice = window.innerWidth <= 1024 || 'ontouchstart' in window;
                    updateMobileInstructions();
                    renderToolSlots(); 
                    renderPotentialTools();
                }
                updateMobileStatus();
                window.addEventListener('resize', updateMobileStatus);

                expressionABtn.addEventListener('click', () => handleAnswer('A'));
                expressionBBtn.addEventListener('click', () => handleAnswer('B'));
                nextQuestionBtn.addEventListener('click', prepareNextQuestion);
                startGameBtn.addEventListener('click', startGame);
                restartBtn.addEventListener('click', startGame);

                helpBtn.addEventListener('click', () => { helpModal.classList.add('show'); populateHelpModalContent(); });
                closeHelpBtn.addEventListener('click', () => helpModal.classList.remove('show'));
                helpModal.addEventListener('click', (e) => { if (e.target === helpModal) helpModal.classList.remove('show'); });
                document.addEventListener('keydown', (e) => { if (e.key === 'Escape' && helpModal.classList.contains('show')) helpModal.classList.remove('show'); });

                expressionABtn.disabled = true; 
                expressionBBtn.disabled = true;
                expressionABtn.classList.add('disabled'); 
                expressionBBtn.classList.add('disabled');
                nextQuestionBtn.style.display = 'none';
                restartBtn.style.display = 'none';
                
                renderToolSlots();
                renderPotentialTools();
                updateStats();
                populateHelpModalContent(); 
            }

            init(); 
        });
    </script>
</body>
</html>
